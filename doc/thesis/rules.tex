This appendix presents the complete type system of Typed Lua.

\section{Subtyping rules}

\noindent

\mylabel{S-LITERAL}
\[
\senv \vdash L \subtype L
\]

\mylabel{S-FALSE}
\[
\senv \vdash \False \subtype \Boolean
\]

\mylabel{S-TRUE}
\[
\senv \vdash \True \subtype \Boolean
\]

\mylabel{S-STRING}
\[
\senv \vdash {\it string} \subtype \String
\]

\mylabel{S-INT1}
\[
\senv \vdash {\it int} \subtype \Integer
\]

\mylabel{S-INT2}
\[
\senv \vdash {\it int} \subtype \Number
\]

\mylabel{S-FLOAT}
\[
\senv \vdash {\it float} \subtype \Number
\]

\mylabel{S-BASE}
\[
\senv \vdash B \subtype B
\]

\mylabel{S-INTEGER}
\[
\senv \vdash \Integer \subtype \Number
\]

\mylabel{S-NIL}
\[
\senv \vdash \Nil \subtype \Nil
\]

\mylabel{S-VALUE}
\[
\senv \vdash F \subtype \Value
\]

\mylabel{S-ANY}
\[
\senv \vdash \Any \subtype \Any
\]

\mylabel{S-SELF}
\[
\senv \vdash \Self \subtype \Self
\]

\mylabel{S-UNION1}
\[
\dfrac{\senv \vdash F_{1} \subtype F \;\;\;
       \senv \vdash F_{2} \subtype F}
      {\senv \vdash F_{1} \cup F_{2} \subtype F}
\]

\mylabel{S-UNION2}
\[
\dfrac{\senv \vdash F \subtype F_{1}}
      {\senv \vdash F \subtype F_{1} \cup F_{2}}
\]

\mylabel{S-UNION3}
\[
\dfrac{\senv \vdash F \subtype F_{2}}
      {\senv \vdash F \subtype F_{1} \cup F_{2}}
\]

\mylabel{S-FUNCTION}
\[
\dfrac{\senv \vdash S_{3} \subtype S_{1} \;\;\;
       \senv \vdash S_{2} \subtype S_{4}}
      {\senv \vdash S_{1} \rightarrow S_{2} \subtype S_{3} \rightarrow S_{4}}
\]

\mylabel{S-PAIR}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2} \;\;\;
       \senv \vdash P_{1} \subtype P_{2}}
      {\senv \vdash F_{1} \times P_{1} \subtype F_{2} \times P_{2}}
\]

\mylabel{S-VARARG1}
\[
\dfrac{\senv \vdash F_{1} \cup \Nil \subtype F_{2} \cup \Nil}
      {\senv \vdash F_{1}{*} \subtype F_{2}{*}}
\]

\mylabel{S-VARARG2}
\[
\dfrac{\senv \vdash F_{1} \cup \Nil \subtype F_{2} \;\;\;
       \senv \vdash F_{1}{*} \subtype P_{2}}
      {\senv \vdash F_{1}{*} \subtype F_{2} \times P_{2}}
\]

\mylabel{S-VARARG3}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2} \cup \Nil \;\;\;
       \senv \vdash P_{1} \subtype F_{2}{*}}
      {\senv \vdash F_{1} \times P_{1} \subtype F_{2}{*}}
\]

\mylabel{S-UNION4}
\[
\dfrac{\senv \vdash S_{1} \subtype S \;\;\;
       \senv \vdash S_{2} \subtype S}
      {\senv \vdash S_{1} \sqcup S_{2} \subtype S}
\]

\mylabel{S-UNION5}
\[
\dfrac{\senv \vdash S \subtype S_{1}}
      {\senv \vdash S \subtype S_{1} \sqcup S_{2}}
\]

\mylabel{S-UNION6}
\[
\dfrac{\senv \vdash S \subtype S_{2}}
      {\senv \vdash S \subtype S_{1} \sqcup S_{2}}
\]

\mylabel{S-TABLE1}
\[
\dfrac{\forall i \; \exists j \;\;\;
       \senv \vdash F_{j} \subtype F_{i}' \;\;\;
       \senv \vdash F_{i}' \subtype F_{j} \;\;\;
       \senv \vdash V_{j} \subtype_{c} V_{i}'}
      {\senv \vdash \{\overline{F{:}V}\}_{fixed|closed} \subtype
                    \{\overline{F'{:}V'}\}_{closed}}
\]

\mylabel{S-TABLE2}
\[
\dfrac{\begin{array}{c}
       \forall i \; \forall j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash V_{i} \subtype_{u} V_{j}'\\
       \forall j \; \nexists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{unique} \subtype
                    \{\overline{F'{:}V'}\}_{closed}}
\]

\mylabel{S-TABLE3}
\[
\dfrac{\begin{array}{c}
       \forall i \; \exists j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \land \senv \vdash V_{i} \subtype_{u} V_{j}' \\
       \forall j \; \nexists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{unique} \subtype
                    \{\overline{F'{:}V'}\}_{unique|open|fixed}}
\]

\mylabel{S-TABLE4}
\[
\dfrac{\begin{array}{c}
       \forall i \; \forall j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \forall j \; \nexists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{open} \subtype
                    \{\overline{F'{:}V'}\}_{closed}}
\]

\mylabel{S-TABLE5}
\[
\dfrac{\begin{array}{c}
       \forall i \; \exists j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \land \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \forall j \; \nexists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{open} \subtype
                    \{\overline{F'{:}V'}\}_{open|fixed}}
\]

\mylabel{S-TABLE6}
\[
\dfrac{\begin{array}{c}
       \forall i \; \exists j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \;\;\;
       \senv \vdash F_{j}' \subtype F_{i} \;\;\;
       \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \forall j \; \exists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \;\;\;
       \senv \vdash F_{j}' \subtype F_{i} \;\;\;
       \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{fixed} \subtype
                    \{\overline{F'{:}V'}\}_{fixed}}
\]

\mylabel{S-FIELD1}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2} \;\;\;
       \senv \vdash F_{2} \subtype F_{1}}
      {\senv \vdash F_{1} \subtype_{c} F_{2}}
\]

\mylabel{S-FIELD2}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash \Const \; F_{1} \subtype_{c} \Const \; F_{2}}
\]

\mylabel{S-FIELD3}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash F_{1} \subtype_{c} \Const \; F_{2}}
\]

\mylabel{S-FIELD4}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash F_{1} \subtype_{u} F_{2}}
\]

\mylabel{S-FIELD5}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash \Const \; F_{1} \subtype_{u} \Const \; F_{2}}
\]

\mylabel{S-FIELD6}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash \Const \; F_{1} \subtype_{u} F_{2}}
\]

\mylabel{S-FIELD7}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash F_{1} \subtype_{u} \Const \; F_{2}}
\]

\mylabel{S-FIELD8}
\[
\dfrac{\senv \vdash \Nil \subtype F}
      {\senv \vdash \Nil \subtype_{o} F}
\]

\mylabel{S-FIELD9}
\[
\dfrac{\senv \vdash \Nil \subtype F}
      {\senv \vdash \Nil \subtype_{o} \Const \; F}
\]

\mylabel{S-AMBER}
\[
\dfrac{\senv[x_{1} \subtype x_{2}] \vdash F_{1} \subtype F_{2}}
      {\senv \vdash \mu x_{1}.F_{1} \subtype \mu x_{2}.F_{2}}
\]

\mylabel{S-ASSUMPTION}
\[
\dfrac{x_{1} \subtype x_{2} \in \senv}
      {\senv \vdash x_{1} \subtype x_{2}}
\]

\mylabel{S-UNFOLDR}
\[
\dfrac{\senv \vdash F_{1} \subtype [x \mapsto \mu x.F_{2}]F_{2}}
      {\senv \vdash F_{1} \subtype \mu x.F_{2}}
\]

\mylabel{S-UNFOLDL}
\[
\dfrac{\senv \vdash [x \mapsto \mu x.F_{1}]F_{1} \subtype F_{2}}
      {\senv \vdash \mu x.F_{1} \subtype F_{2}}
\]

\mylabel{S-EXPRESSION}
\[
\senv \vdash T \subtype T
\]

\mylabel{S-EXPRESSIONLIST}
\[
\senv \vdash E \subtype E
\]

\mylabel{C-ANY1}
\[
\senv \vdash F \lesssim \Any
\]

\mylabel{C-ANY2}
\[
\senv \vdash \Any \lesssim F
\]

\section{Typing rules}

\noindent

\mylabel{T-SKIP}
\[
\env_{1}, \penv \vdash \mathbf{skip}, \env_{1}
\]

\mylabel{T-SEQ}
\[
\dfrac{\env_{1}, \penv \vdash s_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash s_{2}, \env_{3}}
      {\env_{1}, \penv \vdash s_{1} \; ; \; s_{2}, \env_{3}}
\]

\mylabel{T-ASSIGNMENT}
\[
\dfrac{\env_{1}, \penv \vdash el:E_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash \overline{l}:E_{2}, \env_{3} \;\;\;
       E_{1} \lesssim E_{2}}
      {\env_{1}, \penv \vdash \overline{l} = el,\env_{3}}
\]

\mylabel{T-METHOD1}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\;
       T_{s} = \{\overline{F{:}V}\}_{unique} \\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \nexists i \in 1..n \; L \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}| \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, \self \mapsto T_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       T_{o} = \{\overline{F{:}V}, L{:}\Const \; \Self \times F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S\}_{unique}\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto T_{o}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F}){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\;
       T_{s} = \{\overline{F{:}V}\}_{open} \\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \nexists i \in 1..n \; L \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}| \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, \self \mapsto T_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       T_{o} = \{\overline{F{:}V}, L{:}\Const \; \Self \times F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S\}_{open}\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto T_{o}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F}){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD3}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\;
       T_{s} = \{\overline{F{:}V}\}_{unique} \\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \nexists i \in 1..n \; L \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}| \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, {...} \mapsto F, \self \mapsto T_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       T_{o} = \{\overline{F{:}V}, L{:}\Const \; \Self \times F_{1} \times ... \times F_{n} \times F{*} \rightarrow S\}_{unique}\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto T_{o}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F},{...}{:}F){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD4}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\;
       T_{s} = \{\overline{F{:}V}\}_{open} \\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \nexists i \in 1..n \; L \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}| \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, {...} \mapsto F, \self \mapsto T_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       T_{o} = \{\overline{F{:}V}, L{:}\Const \; \Self \times F_{1} \times ... \times F_{n} \times F{*} \rightarrow S\}_{open}\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto T_{o}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F},{...}{:}F){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD5}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\; T_{s} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open} \;\;\;
       \env_{1}, \penv \vdash id_{2} : L, \env_{2}\\
       crall(\env_{1}[self \mapsto \Self, \overline{id} \mapsto \overline{T}, \self \mapsto T_{s}]),
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       \exists i \in 1..n \; L \subtype K_{i} \wedge K_{i} \subtype L \;\;\;
       \Const \; \Self \times \overline{T} \times \Void \rightarrow S \subtype V_{i}\\
       V_{i} = \Const \; \Self \times \overline{T} \times \Void \rightarrow S\\
       T_{o} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open}\\
       \env_{4} = openset(crset(\env_{1}[id_{1} \mapsto T_{o}], fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)),rv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}T}){:}S \; s, \env_{4}\\
       \end{array}}
\]

\mylabel{T-METHOD6}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\; T_{s} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open} \;\;\;
       \env_{1}, \penv \vdash id_{2} : L, \env_{2}\\
       crall(\env_{1}[self \mapsto \Self, \overline{id} \mapsto \overline{T}, {...} \mapsto T, \self \mapsto T_{s}]),
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       \exists i \in 1..n \; L \subtype K_{i} \wedge K_{i} \subtype L \;\;\;
       \Const \; \Self \times \overline{T} \times T{*} \rightarrow S \subtype V_{i}\\
       V_{i} = \Const \; \Self \times \overline{T} \times T{*} \rightarrow S\\
       T_{o} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open}\\
       \env_{4} = openset(crset(\env_{1}[id_{1} \mapsto T_{o}], fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)),rv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}T},{...}{:}T){:}S \; s, \env_{4}\\
       \end{array}}
\]

\mylabel{T-WHILE1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e:T, \env_{2} \;\;\;
       closeall(\env_{2}), \penv \vdash s, \env_{3}\\
       \env_{4} = openset(closeset(\env_{2}, fav(s)),rv(s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{while} \; e \; \mathbf{do} \; s,\env_{4}}
\]

\mylabel{T-WHILE2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2}, filter(T_{1} \cup T_{2}, \Nil))]), \penv \vdash s, \env_{2}\\
       \env_{3} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s)),rv(s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{while} \; id \; \mathbf{do} \; s,\env_{3}}
\]

\mylabel{T-WHILE3}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Nil,i)] \vdash s, \env_{2}\\
       \env_{3} = openset(closeset(\env_{1}, fav(s)),rv(s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{while} \; id \; \mathbf{do} \; s,\env_{3}}
\]

\mylabel{T-IF1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e:T, \env_{2}\\
       closeall(\env_{2}), \penv \vdash s_{1}:\env_{3} \\
       closeall(\env_{2}), \penv \vdash s_{2}:\env_{4} \\
       \env_{5} = openset(closeset(\env_{2}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2})))
       \end{array}}
      {\env_{1} \vdash \mathbf{if} \; e \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{5}}
\]

\mylabel{T-IF2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \Nil))]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\Nil)]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF3}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Nil,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\Nil,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF4}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\Boolean)]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \Boolean))]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``boolean" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF5}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\Boolean,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Boolean,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``boolean" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF6}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\Integer)]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \Integer))]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``integer" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF7}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\Integer,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Integer,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``integer" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF8}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\Number)]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \Number))]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``number" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF9}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\Number,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Number,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``number" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF10}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\String)]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \String))]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``string" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF11}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\String,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\String,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``string" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-LOCAL1}
\[
\dfrac{\env_{1}, \penv \vdash el:S, \env_{2} \;\;\;
       S \lesssim \overline{T} \times \Value{*} \;\;\;
       \env_{2}[\overline{id} \mapsto \overline{T}], \penv \vdash s, \env_{3}}
      {\env_{1}, \penv \vdash \mathbf{local} \; \overline{id{:}T} = el \; \mathbf{in} \; s, \env_{3} - \{\overline{id}\}}
\]

\mylabel{T-LOCAL2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash el:S_{1}, \env_{2}, (x,S_{2})\\
       \env_{2}[id_{1} \mapsto infer(S_{1},1), ..., id_{n} \mapsto infer(S_{1},n)], \penv[x \mapsto S_{2}] \vdash s, \env_{3} \;\;\;
       n = |\;\overline{id}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{local} \; \overline{id} = el \; \mathbf{in} \; s, \env_{3} - \{\overline{id}\}}
\]

\mylabel{T-LOCALREC}
\[
\dfrac{\env_{1}[id \mapsto T], \penv \vdash f:T_{1}, \env_{2} \;\;\;
       T_{1} \lesssim T \;\;\;
       \env_{2}, \penv \vdash s, \env_{3}}
      {\env_{1}, \penv \vdash \mathbf{rec} \; id{:}T = f \; \mathbf{in} \; s, \env_{3} - \{id\}}
\]

\mylabel{T-RETURN}
\[
\dfrac{\env_{1} \vdash el:S_{1}, \env_{2} \;\;\;
       \penv(\ret) = S_{2} \;\;\;
       S_{1} \lesssim S_{2}}
      {\env_{1} \vdash \mathbf{return} \; el, \env_{2}}
\]

\mylabel{T-STMAPPLY1}
\[
\dfrac{\env_{1}, \penv \vdash e(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e(el) \rfloor_{0},\env_{2}}
\]

\mylabel{T-STMINVOKE1}
\[
\dfrac{\env_{1}, \penv \vdash e{:}n(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e{:}n(el) \rfloor_{0}, \env_{2}}
\]

\mylabel{T-NIL}
\[
\env_{1}, \penv \vdash \mathbf{nil}:\Nil, \env_{1}
\]

\mylabel{T-FALSE}
\[
\env_{1}, \penv \vdash \mathbf{false}:\False, \env_{1}
\]

\mylabel{T-TRUE}
\[
\env_{1}, \penv \vdash \mathbf{true}:\True, \env_{1}
\]

\mylabel{T-INT}
\[
\env_{1}, \penv \vdash {\it int}:{\it int}, \env_{1}
\]

\mylabel{T-FLOAT}
\[
\env_{1}, \penv \vdash {\it float}:{\it float}, \env_{1}
\]

\mylabel{T-STR}
\[
\env_{1}, \penv \vdash {\it string}:{\it string}, \env_{1}
\]

\mylabel{T-IDREAD1}
\[
\dfrac{\env_{1}(id) = F}
      {\env_{1}, \penv \vdash id:close(F), \env_{1}[id \mapsto open(F)]}
\]

\mylabel{T-IDREAD2}
\[
\dfrac{\env_{1}(id) = F}
      {\env_{1}, \penv \vdash id:fix(F), \env_{1}[id \mapsto fix(F)]}
\]

\mylabel{T-IDREAD3}
\[
\dfrac{\env_{1}(id) = \phi(F_{1},F_{2})}
      {\env_{1}, \penv \vdash id:F_{2}, \env_{1}}
\]

\mylabel{T-IDREAD4}
\[
\dfrac{\env_{1}(id) = \pi_{i}^{x}}
      {\env_{1}, \penv \vdash id:proj(\penv(x), i), \env_{1}}
\]

\mylabel{T-INDEXREAD1}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \{\overline{F{:}V}\} \;\;\;
       \env_{1}, \penv \vdash e_{2}:F, \env_{2} \;\;\;
       \exists i \in 1{..}n \; F \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}|
       \end{array}}
      {\env_{1}, \penv \vdash id[e_{2}]:rconst(V_{i}), \env_{2}}
\]

\mylabel{T-INDEXREAD2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{1}:\{\overline{F{:}V}\}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3} \;\;\;
       \exists i \in 1{..}n \; F \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}|
       \end{array}}
      {\env_{1}, \penv \vdash e_{1}[e_{2}]:rconst(V_{i}), \env_{3}}
\]

\mylabel{T-INDEXREAD3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1}[e_{2}]:\Any, \env_{3}}
\]

\mylabel{T-COERCE1}
\[
\dfrac{\env_{1}(id) \subtype F \;\;\; tag(F,closed)}
      {\env_{1}, \penv \vdash {<}F{>} \; id:F, \env_{1}[id \mapsto reopen(F)]}
\]

\mylabel{T-COERCE2}
\[
\dfrac{\env_{1}(id) \subtype F \;\;\; tag(F,fixed)}
      {\env_{1}, \penv \vdash {<}F{>} \; id:F, \env_{1}[id \mapsto F]}
\]

\mylabel{T-FUNCTION1}
\[
\dfrac{\begin{array}{c}
       closeall(\env_{1})[\overline{id \mapsto F}], \penv[\ret \mapsto S] \vdash s, \env_{2} \\
       \env_{3} = openset(\env_{1}, frv(\mathbf{fun} \; (\overline{id{:}F}){:}S \; s)) \\
       \env_{4} = closeset(\env_{3}, fav(\mathbf{fun} \; (\overline{id{:}F}){:}S \; s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{fun} \; (\overline{id{:}F}){:}S \; s:F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S, \env_{4}}
\]

\mylabel{T-FUNCTION2}
\[
\dfrac{\begin{array}{c}
       closeall(\env_{1})[\overline{id \mapsto F}, {...} \mapsto F], \penv[\ret \mapsto S] \vdash s, \env_{2} \\
       \env_{3} = openset(\env_{1}, frv(\mathbf{fun} \; (\overline{id{:}F}){:}S \; s)) \\
       \env_{4} = closeset(\env_{3}, fav(\mathbf{fun} \; (\overline{id{:}F}){:}S \; s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{fun} \; (\overline{id{:}F},{...}{:}F){:}S \; s:F_{1} \times ... \times F_{n} \times F{*} \rightarrow S, \env_{4}}
\]

\mylabel{T-CONSTRUCTOR1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash ([e_{1}] = e_{2})_{i}:(F_{i},V_{i}), \env_{i+1} \\
       T = \{F_{1}{:}V_{1}, ..., F_{n}{:}V_{n}\}_{unique} \;\;\;
       wf(T) \;\;\;
       n = |\;\overline{[e_{1}] = e_{2}}\;| \\
       \env_{f} = merge(\env_{1}, ..., \env_{n+1})
       \end{array}}
      {\env_{1}, \penv \vdash \{\;\overline{[e_{1}] = e_{2}}\;\}:T, \env_{f}}
\]

\mylabel{T-CONSTRUCTOR2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash ([e_{1}] = e_{2})_{i}:(K_{i},V_{i}), \env_{i+1} \\
       \env_{1}, \penv \vdash me : T_{n+1} \times ... \times T_{n+m} \times T_{n+m+1}{*}, \env_{n+2}\\
       T = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}, 1:T_{n+1}, ..., m:T_{n+m}, \Integer:T_{n+m+1} \cup \Nil\}_{unique}\\
       wf(T) \;\;\;
       n = |\;\overline{[e_{1}] = e_{2}}\;| \;\;\;
       \env_{f} = merge(\env_{1}, ..., \env_{n+2})
       \end{array}}
      {\env_{1}, \penv \vdash \{\;\overline{[e_{1}] = e_{2}}\;\}:T, \env_{f}}
\]

\mylabel{T-FIELD1}
\[
\dfrac{\env_{1}, \penv \vdash e_{2}:T_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{1}:T_{1}, \env_{3} \;\;\;
       T_{1} \subtype \Boolean}
      {\env_{1}, \penv \vdash [e_{1}] = e_{2}: (T_{1},close(T_{2})), \env_{3}}
\]

\mylabel{T-FIELD2}
\[
\dfrac{\env_{1}, \penv \vdash e_{2}:T_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{1}:T_{1}, \env_{3} \;\;\;
       T_{1} \subtype \Number}
      {\env_{1}, \penv \vdash [e_{1}] = e_{2}: (T_{1},close(T_{2})), \env_{3}}
\]

\mylabel{T-FIELD3}
\[
\dfrac{\env_{1}, \penv \vdash e_{2}:T_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{1}:T_{1}, \env_{3} \;\;\;
       T_{1} \subtype \String}
      {\env_{1}, \penv \vdash [e_{1}] = e_{2}: (T_{1},close(T_{2})), \env_{3}}
\]

\mylabel{T-FIELD4}
\[
\dfrac{\env_{1}, \penv \vdash e_{2}:T_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{1}:T_{1}, \env_{3}}
      {\env_{1}, \penv \vdash [e_{1}] = e_{2}: (\Value,close(T_{2})), \env_{3}}
\]

\mylabel{T-ARITH1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Integer \;\;\;
       T_{2} \subtype \Integer}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Integer, \env_{3}}
\]

\mylabel{T-ARITH2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Integer \;\;\;
       T_{2} \subtype \Number}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Number \;\;\;
       T_{2} \subtype \Integer}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Number \;\;\;
       T_{2} \subtype \Number}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH5}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Any, \env_{3}}
\]

\mylabel{T-ARITH6}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Any, \env_{3}}
\]

\mylabel{T-CONCAT1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \String \;\;\;
       T_{2} \subtype \String}
      {\env_{1}, \penv \vdash e_{1} \; {..} \; e_{2}:\String, \env_{3}}
\]

\mylabel{T-CONCAT2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; {..} \; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-CONCAT3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; {..} \; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-EQUAL}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} == e_{2}:\Boolean, \env_{3}}
\]

\mylabel{T-ORDER1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Number \;\;\;
       T_{2} \subtype \Number}
      {\env, \penv \vdash e_{1} < e_{2}:\Boolean, \env_{3}}
\]

\mylabel{T-ORDER2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \String \;\;\;
       T_{2} \subtype \String}
      {\env_{1}, \penv \vdash e_{1} < e_{2}:\Boolean}
\]

\mylabel{T-ORDER3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} < e_{2}:\Any, \env_{3}}
\]

\mylabel{T-ORDER4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} < e_{2}:\Any, \env_{3}}
\]

\mylabel{T-BITWISE1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Integer \;\;\;
       T_{2} \subtype \Integer}
      {\env_{1}, \penv \vdash e_{1} \;\&\; e_{2}:\Integer, \env_{3}}
\]

\mylabel{T-BITWISE2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \;\&\; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-BITWISE3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \;\&\; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-AND1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil, \env_{2}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:\Nil, \env_{2}}
\]

\mylabel{T-AND2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\False, \env_{2}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:\False, \env_{2}}
\]

\mylabel{T-AND3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil \cup \False, \env_{2}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:\Nil \cup \False, \env_{2}}
\]

\mylabel{T-AND4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       \Nil \not\lesssim T_{1} \;\;\;
       \False \not\lesssim T_{1}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:T_{2}, \env_{3}}
\]

\mylabel{T-AND5}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:T_{1} \cup T_{2}, \env_{3}}
\]

\mylabel{T-OR1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \Nil \not\lesssim T \;\;\;
       \False \not\lesssim T}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:T, \env_{2}}
\]

\mylabel{T-OR2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:T, \env_{3}}
\]

\mylabel{T-OR3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\False, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:T, \env_{3}}
\]

\mylabel{T-OR4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil \cup \False, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:T, \env_{3}}
\]

\mylabel{T-OR5}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:filter(filter(T_{1}, \Nil), \False) \cup T_{2}, \env_{3}}
\]

\mylabel{T-NOT1}
\[
\dfrac{\env_{1}, \penv \vdash e:\Nil, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\True, \env_{2}}
\]

\mylabel{T-NOT2}
\[
\dfrac{\env_{1}, \penv \vdash e:\False, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\True, \env_{2}}
\]

\mylabel{T-NOT3}
\[
\dfrac{\env_{1}, \penv \vdash e:\Nil \cup \False, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\True, \env_{2}}
\]

\mylabel{T-NOT4}
\[
\dfrac{\env_{1}, \penv \vdash e:T \;\;\;
       \Nil \not\lesssim T \;\;\;
       \False \not\lesssim T}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\False, \env_{2}}
\]

\mylabel{T-NOT5}
\[
\dfrac{\env_{1}, \penv \vdash e:T, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\Boolean, \env_{2}}
\]

\mylabel{T-LEN1}
\[
\dfrac{\env_{1}, \penv \vdash e:T, \env_{2} \;\;\;
       T \subtype \String}
      {\env_{1}, \penv \vdash \# \; e:\Integer, \env_{2}}
\]

\mylabel{T-LEN2}
\[
\dfrac{\env_{1}, \penv \vdash e:T, \env_{2} \;\;\;
       T \subtype \{\}_{closed}}
      {\env_{1}, \penv \vdash \# \; e:\Integer, \env_{2}}
\]

\mylabel{T-LEN3}
\[
\dfrac{\env_{1}, \penv \vdash e:\Any, \env_{2}}
      {\env_{1}, \penv \vdash \# \; e:\Any, \env_{2}}
\]

\mylabel{T-EXPAPPLY1}
\[
\dfrac{\env_{1}, \penv \vdash e(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e(el) \rfloor_{1}:first(S), \env_{2}}
\]

\mylabel{T-EXPINVOKE1}
\[
\dfrac{\env_{1}, \penv \vdash e{:}n(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e{:}n(el) \rfloor_{1}:first(S), \env_{2}}
\]

\mylabel{T-EXPDOTS}
\[
\dfrac{\env_{1}, \penv \vdash {...}:T{*}, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor {...} \rfloor_{1}:T \cup \Nil, \env_{2}}
\]

\mylabel{T-IDWRITE}
\[
\dfrac{\env_{1}(id) = F}
      {\env_{1}, \penv \vdash id_{l}:F, \env_{1}}
\]

\mylabel{T-REFINE1}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \{\overline{F{:}V}\}_{unique}\\
       \env_{1}, \penv \vdash e:F_{new}, \env_{2} \;\;\;
       \nexists i \in 1..n \; F_{new} \lesssim F_{i} \;\;\;
       V_{new} = vt(F_{new},V) \;\;\; n = |\overline{F{:}V}|
       \end{array}}
      {\env_{1}, \penv \vdash id[e] {<}V{>}:V_{new}, \env_{2}[id \mapsto \{\overline{F{:}V}, F_{new}{:}V_{new}\}_{unique}]}
\]

\mylabel{T-REFINE2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \{\overline{F{:}V}\}_{open}\\
       \env_{1}, \penv \vdash e:F_{new}, \env_{2} \;\;\;
       \nexists i \in 1..n \; F_{new} \lesssim F_{i} \;\;\;
       V_{new} = vt(F_{new},V) \;\;\; n = |\overline{F{:}V}|
       \end{array}}
      {\env_{1}, \penv \vdash id[e] {<}V{>}:V_{new}, \env_{2}[id \mapsto \{\overline{F{:}V}, F_{new}{:}V_{new}\}_{open}]}
\]

\mylabel{T-LHSLIST}
\[
\dfrac{\env_{1}, \penv \vdash l_{i}:T_{i}, \env_{i+1} \;\;\;
       \env_{f} = merge(\env_{1}, ..., \env_{n+1}) \;\;\;
       n = |\;\overline{l}\;|}
      {\env_{1}, \penv \vdash \overline{l}:T_{1} \times ... \times T_{n} \times \Value{*}, \env_{f}}
\]

\mylabel{T-EXPLIST1}
\[
\dfrac{\env_{1}, \penv \vdash e_{i}:T_{i}, \env_{i+1} \;\;\;
       \env_{f} = merge(\env_{1}, ..., \env_{n+1}) \;\;\;
       n = |\;\overline{e}\;|}
      {\env_{1}, \penv \vdash \overline{e}:T_{1} \times ... \times T_{n} \times \Nil{*}, \env_{f}}
\]

\mylabel{T-EXPLIST2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{i}:T_{i}, \env_{i+1} \;\;\;
       \env_{1}, \penv \vdash me:T_{n+1} \times ... \times T_{n+m} \times \Void, \env_{n+2}\\
       \env_{f} = merge(\env_{1}, ..., \env_{n+2}) \;\;\;
       n = |\;\overline{e}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \overline{e},me:T_{1} \times ... \times T_{n+m} \times \Nil{*}, \env_{f}}
\]

\mylabel{T-EXPLIST3}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{i}:T_{i}, \env_{i+1} \;\;\;
       \env_{1}, \penv \vdash me:T_{n+1} \times ... \times T_{n+m}{*}, \env_{n+2}\\
       \env_{f} = merge(\env_{1}, ..., \env_{n+2}) \;\;\;
       n = |\;\overline{e}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \overline{e},me:T_{1} \times ... \times T_{n+m}{*}, \env_{f}}
\]

\mylabel{T-EXPLIST4}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{i}:T_{i}, \env_{i+1} \;\;\;
       \env_{1}, \penv \vdash me:S, \env_{n+2}\\
       S = T_{n+1} \times ... \times T_{n+m} \times \Void \sqcup T_{n+1}' \times ... \times T_{n+m}' \times \Void\\
       \env_{f} = merge(\env_{1}, ..., \env_{n+2}) \;\;\;
       n = |\;\overline{e}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \overline{e},me:T_{1} \times ... \times T_{n} \times \pi_{1}^{x} \times ... \times \pi_{m}^{x} \times \Nil{*}, \env_{f}, (x,S)}
\]

\mylabel{T-APPLY1}
\[
\dfrac{\env_{1}, \penv \vdash e:S_{1} \rightarrow S_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash el:S_{3}, \env_{3} \;\;\;
       S_{3} \lesssim S_{1}}
      {\env_{1}, \penv \vdash e(el):S_{2}, \env_{3}}
\]

\mylabel{T-APPLY2}
\[
\dfrac{\env_{1}, \penv \vdash e:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash el:S, \env_{3}}
      {\env_{1}, \penv \vdash e_{1}(el):\Any{*}, \env_{3}}
\]

\mylabel{T-INVOKE1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e:T_{s}, \env_{2}\\
       \env_{2}[\sigma \mapsto T_{s}], \penv \vdash e[id]:\Const \; S_{1} \rightarrow S_{2}, \env_{3}\\
       \env_{3}[\sigma \mapsto T_{s}], \penv \vdash el:S_{3}, \env_{4} \;\;\;
       T_{s} \times S_{3} \lesssim S_{1}
       \end{array}}
      {\env_{1}, \penv \vdash e{:}id(el):[\sigma \mapsto T]S_{2}, \env_{4}}
\]

\mylabel{T-INVOKE2}
\[
\dfrac{\env_{1}, \penv \vdash e:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash el:S, \env_{3}}
      {\env_{1}, \penv \vdash e{:}id(el):\Any{*}, \env_{3}}
\]

\mylabel{T-DOTS}
\[
\dfrac{\env_{1}({...}) = T}
      {\env_{1}, \penv \vdash {...}:T{*}, \env_{1}}
\]

\mylabel{T-SELF}
\[
\dfrac{\env_{1}, \penv \vdash e:\Self, \env_{2} \;\;\;
       \env_{2}(\self) = T}
      {\env_{1}, \penv \vdash e:T, \env_{2}}
\]

\mylabel{T-SETMETATABLE1}
\[
\dfrac{\env(id) = \Self}
      {\env, \penv \vdash setmetatable(\{\}, \{[``\string_\string_index"] = id\}):\Self, \env}
\]

\mylabel{T-SETMETATABLE2}
\[
\dfrac{\env(id) = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{fixed}}
      {\env, \penv \vdash setmetatable(\{\}, \{[``\string_\string_index"] = id\}):\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{open}, \env}
\]

\mylabel{T-SETMETATABLE3}
\[
\dfrac{\env_{1}, \penv \vdash e = T, \env_{2} \;\;\;
       T = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{closed} \;\;\;
       \env_{1}(id) = \Self \;\;\; \env_{1}(\sigma) \subtype T}
      {\env_{1}, \penv \vdash setmetatable(e, \{[``\string_\string_index"] = id\}):\Self, \env_{2}[\sigma \mapsto T]}
\]

\mylabel{T-UNFOLD}
\[
\dfrac{\env_{1}, \penv \vdash e:\mu x.T, \env_{2}}
      {\env_{1}, \penv \vdash e:[x \mapsto \mu x.T]T, \env_{2}}
\]

\mylabel{T-FOLD}
\[
\dfrac{\env_{1}, \penv \vdash e:[x \mapsto \mu x.T]T, \env_{2}}
      {\env_{1}, \penv \vdash e:\mu x.T, \env_{2}}
\]

\mylabel{T-TERNARY}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       \env_{3}, \penv \vdash e_{3}:T_{2}, \env_{4}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2} \; \mathbf{or} \; e_{3}:T_{2}, \env_{4}}
\]

\section{Auxiliary functions}

\noindent

\begin{align*}
wf(\{\overline{F:V}\}_{unique|open|fixed|closed}) & = \forall i \; ((\nexists j \; i \not= j \,\wedge\, F_{i} \lesssim F_{j}) \,\wedge\, wf(V_{i}) \,\wedge\\
& \;\;\;\; \lnot tag(V_{i},unique) \,\wedge\, \lnot tag(V_{i},open))\\
wf({\bf const}\; F) & = wf(F) \\
wf(F_1 \cup F_2) & = wf(F_1) \,\wedge\, wf(F_2) \\
wf(\mu x.F) & = wf(F) \\
wf(S_1 \rightarrow S_2) & = wf(S_1) \,\wedge\, wf(S_2) \\
wf(S_1 \sqcup S_2) & = wf(S_1) \,\wedge\, wf(S_2)\\
wf(F{*}) & = wf(F) \\
wf(F \times P) & = wf(F) \,\wedge\,wf(P)\\
wf(F) & = \top\\
\\
tag(F_1 \cup F_2, t) & = tag(F_1, t) \,\vee\, tag(F_2,t) \\
tag(\{\overline{F{:}V}\}_t, t) & = \top\\
tag(F, t) & = \bot\\
\\
vt(L, V) & = fix(V) \\
vt(F_1, F_2) & = nil(fix(F_2))\\
vt(F_1, {\bf const}\;F_2) & = {\bf const}\;nil(fix(F_2))\\
\\
nil(T) & = T \;\;\; \mathrm{if}\;\Nil \lesssim T\\
nil(T) & = T \cup \Nil \;\;\; \mathrm{otherwise}\\
\\
first(\Void) & = \Nil\\
first(T{*}) & = T \cup \Nil\\
first(T \times P) & = T\\
first(S_{1} \sqcup S_{2}) & = first(S_{1}) \cup first(S_{2})\\
\\
infer(T_{1} \times ... \times T_{n}{*}, i) & = \left\{
\begin{array}{ll}
general(T_{i}) & \text{if $i < n$}\\
general(T_{n} \cup \Nil) & \text{if $i >= n$}
\end{array} \right.
\\ \\
general(\False) & = \Boolean\\
general(\True) & = \Boolean\\
general({\it int}) & = \Integer\\
general({\it float}) & = \Number\\
general({\it string}) & = \String\\
general(T_{1} \cup T_{2}) & = general(T_{1}) \cup general(T_{2})\\
general(S_{1} \rightarrow S_{2}) & = general2(S_{1}) \rightarrow general2(S_{2})\\
general(\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{tag}) & = \{K_{1}{:}general(V_{1}), ..., K_{n}{:}general(V_{n})\}_{tag}\\
general(\mu x.T) & = \mu x.general(T)\\
general(T) & = T\\
\\
general2(\Void) & = \Void\\
general2(T{*}) & = general(T){*}\\
general2(T \times P) & = general(T) \times general2(P)\\
general2(S_{1} \sqcup S_{2}) & = general2(S_{1}) \sqcup general2(S_{2})\\
\\
proj(S_1 \sqcup S_2, i) & = proj(S_1, i) \cup proj(S_2, i) \\
proj(F{*}, i) & = nil(F) \\
proj(F \times P, 1) & = F \\
proj(F \times P, i) & = proj(P, i-1)\\
proj(E{*}, i) & = nil(E) \\
proj(T \times E, 1) & = T \\
proj(T \times E, i) & = proj(E, i-1)\\
\\
filter(T_{1} \cup T_{2}, T_{1}) & = filter(T_{2}, T_{1})\\
filter(T_{1} \cup T_{2}, T_{2}) & = filter(T_{1}, T_{2})\\
filter(T_{1} \cup T_{2}, T_{3}) & = filter(T_{1}, T_{3}) \cup filter(T_{2}, T_{3})\\
filter(T_{1}, T_{2}) & = T_{1}\\
\\
fonilpt(P_1 \sqcup P_2) & = P_2 \;\;\; \mathrm{if} \; fonil(proj(P_1, i)) = {\bf void} \\
fonilpt(P_1 \sqcup P_2) & = P_1 \;\;\; \mathrm{if} \; fonil(proj(P_2, i)) = {\bf void} \\
fonilpt(P_1 \sqcup P_2) & = P_1 \sqcup P_2 \;\;\; \mathrm{otherwise}\\
fonilpt(P \sqcup S) & = fonilpt(S) \;\;\; \mathrm{if} \; fonil(proj(P, i)) = {\bf void} \\
fonilpt(P \sqcup S) & = P \sqcup fonilpt(S) \;\;\; \mathrm{otherwise}\\
fonilpt(S \sqcup P_2) & = fonilpt(S) \;\;\; \mathrm{if} \; fonil(proj(P, i)) = {\bf void} \\
fonilpt(S \sqcup P) & = fonilpt(S) \sqcup P \;\;\; \mathrm{otherwise}\\
fonilpt(S_1 \sqcup S_2) & = fonilpt(S_1) \sqcup fonilpt(S_2)\\
\\
fonil(F_1 \cup F_2) & = fonil(F_1) \;\;\; \mathrm{if}\;fonil(F_2) = {\bf void}\\
fonil(F_1 \cup F_2) & = fonil(F_2) \;\;\; \mathrm{if}\;fonil(F_1) = {\bf void}\\
fonil(F_1 \cup F_2) & = fonil(F_1) \cup fonil(F_2) \;\;\; \mathrm{otherwise}\\
fonil(F) & = {\bf void} \;\;\; \mathrm{if} \; F \subtype \Nil \; \mathrm{and} \; \Nil \subtype F\\
fonil(F) & = F \;\;\; \mathrm{otherwise}\\
\\
close(F_{1} \cup F_{2}) & = close(F_{1}) \cup close(F_{2})\\
close(\{\overline{F{:}V}\}_{unique|open}) & = \{\overline{F{:}V}\}_{closed} \\
close(F) & = F\\
\\
fix(F_{1} \cup F_{2}) & = fix(F_{1}) \cup fix(F_{2})\\
fix(\{\overline{F{:}V}\}_{unique|open}) & = \{\overline{F{:}V}\}_{fixed} \\
fix(F) & = F\\
\\
open(F_{1} \cup F_{2}) & = open(F_{1}) \cup open(F_{2})\\
open(\{\overline{F{:}V}\}_{unique}) & = \{\overline{F{:}V}\}_{open} \\
open(F) & = F\\
\end{align*}

\begin{align*}
closeall(\env[id_{1} \mapsto T_{1}, ..., id_{n} \mapsto T_{n}]) & = \env[id_{1} \mapsto close(T_{1}), ..., id_{n} \mapsto close(T_{n})]
\end{align*}

\begin{align*}
closeset(\env, \{id_{1}, ..., id_{n}\}) & = \env[id_{1} \mapsto close(\env(id_{1})), ..., id_{n} \mapsto close(\env(id_{n}))]
\end{align*}

\begin{align*}
openset(\env, \{id_{1}, ..., id_{n}\}) & = \env[id_{1} \mapsto open(\env(id_{1})), ..., id_{n} \mapsto open(\env(id_{n}))]
\end{align*}

\begin{align*}
merge(\overline{\env}) & = reduce(\overline{\env}, merge2)\\
merge2(\env_1,\env_2) & = \{\overline{(id,merget(\env_1(id),\env_2(id))}\}\\
merget(T_1, T_2) & = T_1 \;\;\; \mathrm{if\;} T_2 \lesssim T_1\\
merget(T_1, T_2) & = T_2 \;\;\; \mathrm{if\;} T_1 \lesssim T_2\\
%\mathrm{the\;next\;case\;applies\;if}
%\overline{V^l \lesssim_u V_r \,\vee\, V^r \lesssim_u V_l}\;\mathrm{and\;the\;right\; side\; is\;}wf}\\
merget(\{\overline{F:V^l},\overline{F^{\prime}:V^\prime}\}_{unique},
       \{\overline{F:V^r},\overline{F^{\prime\prime}:V^{\prime\prime}}\}_{unique}) & =
       \{\overline{F:sup_u(V^l,V^r)},\overline{F^\prime:V^\prime},\overline{F^{\prime\prime}:V^{\prime\prime}}\}_{unique}\\
%& \mathrm{the\;next\;case\;applies\;if}\;
%  \overline{V^l \lesssim_c V_r \,\vee\, V^r \lesssim_c V_l}\;\mathrm{and\;the\;right\; side\; is\;}wf}\\
merget(\{\overline{F:V^l},\overline{F^{\prime}:V^{\prime}}\}_{unique|open},
       \{\overline{F:V^r},\overline{F^{\prime\prime}:V^{\prime\prime}}\}_{unique|open}) & =
       \{\overline{F:sup_c(V^l,V^r)},\overline{F^\prime:V^\prime},\overline{F^{\prime\prime}:V^{\prime\prime}}\}_{open}\\
merget(T_1, T_2) & = \bot \;\;\; \mathrm{otherwise}
\end{align*}

\begin{align*}
join(\env_1,\env_2) & = \{\overline{(id,joint(\env_1(id),\env_2(id))}\}\\
joint(T_1, T_2) & = T_1 \;\;\; \mathrm{if\;} T_2 \lesssim T_1\\
joint(T_1, T_2) & = T_2 \;\;\; \mathrm{if\;} T_1 \lesssim T_2\\
%\mathrm{the\;next\;case\;applies\;if}\;
%\overline{V^l \lesssim_u V_r \,\vee\, V^r \lesssim_u V_l}\;\mathrm{and\;the\;right\; side\; is\;}wf}\\
joint(\{\overline{F:V^l},\overline{F^{\prime}:V^{\prime}}\}_{unique},
\{\overline{F:V^r},\overline{F^{\prime\prime}:V^{\prime\prime}}\}_{unique}) & =
\{\overline{F:sup_u(V^l,V^r)},\overline{F^\prime:nil(V^\prime)},\overline{F^{\prime\prime}:nil(V^{\prime\prime})}\}_{unique}\\
joint(T_1, T_2) & = \bot \;\;\; \mathrm{otherwise}
\end{align*}

\begin{align*}
sup_u(V_1, V_2) & = V_2 \;\;\; \mathrm{if}\; V_1 \lesssim_u V_2\\
sup_u(V_1, V_2) & = V_1 \;\;\; \mathrm{if}\; V_2 \lesssim_u V_1\\
\\
reopen(\{\overline{F:V}\}_{closed}) & = \{\overline{F:V}\}_{open}\\
reopen(F) & = F
\end{align*}
