This appendix presents the complete type system of Typed Lua.

\section{Subtyping rules}

\noindent

\mylabel{S-LITERAL}
\[
\senv \vdash L \subtype L
\]

\mylabel{S-FALSE}
\[
\senv \vdash \False \subtype \Boolean
\]

\mylabel{S-TRUE}
\[
\senv \vdash \True \subtype \Boolean
\]

\mylabel{S-STRING}
\[
\senv \vdash {\it string} \subtype \String
\]

\mylabel{S-INT1}
\[
\senv \vdash {\it int} \subtype \Integer
\]

\mylabel{S-INT2}
\[
\senv \vdash {\it int} \subtype \Number
\]

\mylabel{S-FLOAT}
\[
\senv \vdash {\it float} \subtype \Number
\]

\mylabel{S-BASE}
\[
\senv \vdash B \subtype B
\]

\mylabel{S-NUMBER}
\[
\senv \vdash \Integer \subtype \Number
\]

\mylabel{S-NIL}
\[
\senv \vdash \Nil \subtype \Nil
\]

\mylabel{S-VALUE}
\[
\senv \vdash T \subtype \Value
\]

\mylabel{S-ANY}
\[
\senv \vdash \Any \subtype \Any
\]

\mylabel{S-SELF}
\[
\senv \vdash \Self \subtype \Self
\]

\mylabel{S-UNION1}
\[
\dfrac{\senv \vdash T_{1} \subtype T \;\;\;
       \senv \vdash T_{2} \subtype T}
      {\senv \vdash T_{1} \cup T_{2} \subtype T}
\]

\mylabel{S-UNION2}
\[
\dfrac{\senv \vdash T \subtype T_{1}}
      {\senv \vdash T \subtype T_{1} \cup T_{2}}
\]

\mylabel{S-UNION3}
\[
\dfrac{\senv \vdash T \subtype T_{2}}
      {\senv \vdash T \subtype T_{1} \cup T_{2}}
\]

\mylabel{S-FUNCTION}
\[
\dfrac{\senv \vdash S_{3} \subtype S_{1} \;\;\;
       \senv \vdash S_{2} \subtype S_{4}}
      {\senv \vdash S_{1} \rightarrow S_{2} \subtype S_{3} \rightarrow S_{4}}
\]

\mylabel{S-VOID1}
\[
\senv \vdash \Void \subtype \Void
\]

\mylabel{S-VOID2}
\[
\senv \vdash \Void \subtype T{*}
\]

\mylabel{S-PAIR}
\[
\dfrac{\senv \vdash T_{1} \subtype T_{2} \;\;\;
       \senv \vdash P_{1} \subtype P_{2}}
      {\senv \vdash T_{1} \times P_{1} \subtype T_{2} \times P_{2}}
\]

\mylabel{S-VARARG1}
\[
\senv \vdash \Nil{*} \subtype \Void
\]

\mylabel{S-VARARG2}
\[
\dfrac{\senv \vdash T_{1} \cup \Nil \subtype T_{2} \cup \Nil}
      {\senv \vdash T_{1}{*} \subtype T_{2}{*}}
\]

\mylabel{S-VARARG3}
\[
\dfrac{\senv \vdash T_{1} \cup \Nil \subtype T_{2}}
      {\senv \vdash T_{1}{*} \subtype T_{2} \times \Void}
\]

\mylabel{S-VARARG4}
\[
\dfrac{\senv \vdash T_{1} \subtype T_{2} \cup \Nil}
      {\senv \vdash T_{1} \times \Void \subtype T_{2}{*}}
\]

\mylabel{S-VARARG5}
\[
\dfrac{\senv \vdash T_{1}{*} \subtype T_{2} \times \Void \;\;\;
       \senv \vdash T_{1}{*} \subtype P_{2}}
      {\senv \vdash T_{1}{*} \subtype T_{2} \times P_{2}}
\]

\mylabel{S-VARARG6}
\[
\dfrac{\senv \vdash T_{1} \times \Void \subtype T_{2}{*} \;\;\;
       \senv \vdash P_{1} \subtype T_{2}{*}}
      {\senv \vdash T_{1} \times P_{1} \subtype T_{2}{*}}
\]

\mylabel{S-UNION4}
\[
\dfrac{\senv \vdash S_{1} \subtype S \;\;\;
       \senv \vdash S_{2} \subtype S}
      {\senv \vdash S_{1} \sqcup S_{2} \subtype S}
\]

\mylabel{S-UNION5}
\[
\dfrac{\senv \vdash S \subtype S_{1}}
      {\senv \vdash S \subtype S_{1} \sqcup S_{2}}
\]

\mylabel{S-UNION6}
\[
\dfrac{\senv \vdash S \subtype S_{2}}
      {\senv \vdash S \subtype S_{1} \sqcup S_{2}}
\]

\mylabel{S-TABLE1}
\[
\dfrac{\forall i \in 1..n \; \exists j \in 1..m \;\;\;
       \senv \vdash K_{j} \subtype K_{i}' \;\;\;
       \senv \vdash K_{i}' \subtype K_{j} \;\;\;
       \senv \vdash V_{j} \subtype_{c} V_{i}'}
      {\senv \vdash \{K_{1}{:}V_{1}, ..., K_{m}{:}V_{m}\}_{fixed|closed} \subtype
                    \{K_{1}'{:}V_{1}', ..., K_{n}'{:}V_{n}'\}_{closed}} \; m \ge n
\]

\mylabel{S-TABLE2}
\[
\dfrac{\begin{array}{c}
       \forall i \in 1..m \; \forall j \in 1..n \;
       \senv \vdash K_{i} \subtype K_{j}' \to \senv \vdash V_{i} \subtype_{u} V_{j}' \\
       \forall j \in 1..n \; \not\exists i \in 1..m \;
       \senv \vdash K_{i} \subtype K_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{K_{1}{:}V_{1}, ..., K_{m}{:}V_{m}\}_{unique} \subtype
                    \{K_{1}'{:}V_{1}', ..., K_{n}'{:}V_{n}'\}_{closed}}
\]

\mylabel{S-TABLE3}
\[
\dfrac{\begin{array}{c}
       \forall i \in 1..m \\
       \exists j \in 1..n \;
       \senv \vdash K_{i} \subtype K_{j}' \land \senv \vdash V_{i} \subtype_{u} V_{j}' \\
       \forall j \in 1..n \; \not\exists i \in 1..m \;
       \senv \vdash K_{i} \subtype K_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{K_{1}{:}V_{1}, ..., K_{m}{:}V_{m}\}_{unique} \subtype
                    \{K_{1}'{:}V_{1}', ..., K_{n}'{:}V_{n}'\}_{unique|open|fixed}}
\]

\mylabel{S-TABLE4}
\[
\dfrac{\begin{array}{c}
       \forall i \in 1..m \; \forall j \in 1..n \;
       \senv \vdash K_{i} \subtype K_{j}' \to \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \forall j \in 1..n \; \not\exists i \in 1..m \;
       \senv \vdash K_{i} \subtype K_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{K_{1}{:}V_{1}, ..., K_{m}{:}V_{m}\}_{open} \subtype
                    \{K_{1}'{:}V_{1}', ..., K_{n}'{:}V_{n}'\}_{closed}}
\]

\mylabel{S-TABLE5}
\[
\dfrac{\begin{array}{c}
       \forall i \in 1..m \\
       \exists j \in 1..n \;
       \senv \vdash K_{i} \subtype K_{j}' \land \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \forall j \in 1..n \; \not\exists i \in 1..m \;
       \senv \vdash K_{i} \subtype K_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{K_{1}{:}V_{1}, ..., K_{m}{:}V_{m}\}_{open} \subtype
                    \{K_{1}'{:}V_{1}', ..., K_{n}'{:}V_{n}'\}_{open|fixed}}
\]

\mylabel{S-TABLE6}
\[
\dfrac{\forall i \in 1..n \; \exists j \in 1..n \;\;\;
       \senv \vdash K_{j} \subtype K_{i}' \;\;\;
       \senv \vdash K_{i}' \subtype K_{j} \;\;\;
       \senv \vdash V_{j} \subtype_{c} V_{i}'}
      {\senv \vdash \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{fixed} \subtype
                    \{K_{1}'{:}V_{1}', ..., K_{n}'{:}V_{n}'\}_{fixed}}
\]

\mylabel{S-FIELD1}
\[
\dfrac{\senv \vdash V_{1} \subtype V_{2} \;\;\;
       \senv \vdash V_{2} \subtype V_{1}}
      {\senv \vdash V_{1} \subtype_{c} V_{2}}
\]

\mylabel{S-FIELD2}
\[
\dfrac{\senv \vdash V_{1} \subtype V_{2}}
      {\senv \vdash \Const \; V_{1} \subtype_{c} \Const \; V_{2}}
\]

\mylabel{S-FIELD3}
\[
\dfrac{\senv \vdash V_{1} \subtype V_{2}}
      {\senv \vdash V_{1} \subtype_{c} \Const \; V_{2}}
\]

\mylabel{S-FIELD4}
\[
\dfrac{\senv \vdash V_{1} \subtype V_{2}}
      {\senv \vdash V_{1} \subtype_{u} V_{2}}
\]

\mylabel{S-FIELD5}
\[
\dfrac{\senv \vdash V_{1} \subtype V_{2}}
      {\senv \vdash \Const \; V_{1} \subtype_{u} \Const \; V_{2}}
\]

\mylabel{S-FIELD6}
\[
\dfrac{\senv \vdash V_{1} \subtype V_{2}}
      {\senv \vdash V_{1} \subtype_{u} \Const \; V_{2}}
\]

\mylabel{S-FIELD7}
\[
\dfrac{\senv \vdash \Nil \subtype V}
      {\senv \vdash \Nil \subtype_{o} V}
\]

\mylabel{S-FIELD8}
\[
\dfrac{\senv \vdash \Nil \subtype V}
      {\senv \vdash \Nil \subtype_{o} \Const \; V}
\]

\mylabel{S-AMBER}
\[
\dfrac{\senv[x_{1} \subtype x_{2}] \vdash T_{1} \subtype T_{2}}
      {\senv \vdash \mu x_{1}.T_{1} \subtype \mu x_{2}.T_{2}}
\]

\mylabel{S-ASSUMPTION}
\[
\dfrac{x_{1} \subtype x_{2} \in \senv}
      {\senv \vdash x_{1} \subtype x_{2}}
\]

\mylabel{S-UNFOLDR}
\[
\dfrac{\senv \vdash T_{1} \subtype [x \mapsto \mu x.T_{2}]T_{2}}
      {\senv \vdash T_{1} \subtype \mu x.T_{2}}
\]

\mylabel{S-UNFOLDL}
\[
\dfrac{\senv \vdash [x \mapsto \mu x.T_{1}]T_{1} \subtype T_{2}}
      {\senv \vdash \mu x.T_{1} \subtype T_{2}}
\]

\mylabel{S-FILTER}
\[
\senv \vdash \phi(T_{1},T_{2}) \subtype \phi(T_{1},T_{2})
\]

\mylabel{S-PROJECTION}
\[
\senv \vdash \pi_{i}^{x} \subtype \pi_{i}^{x}
\]

\mylabel{C-ANY1}
\[
\senv \vdash T \lesssim \Any
\]

\mylabel{C-ANY2}
\[
\senv \vdash \Any \lesssim T
\]

\section{Typing rules}

\noindent

\mylabel{T-SKIP}
\[
\env_{1}, \penv \vdash \mathbf{skip}, \env_{1}
\]

\mylabel{T-SEQ}
\[
\dfrac{\env_{1}, \penv \vdash s_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash s_{2}, \env_{3}}
      {\env_{1}, \penv \vdash s_{1} \; ; \; s_{2}, \env_{3}}
\]

\mylabel{T-ASSIGNMENT}
\[
\dfrac{\env_{1}, \penv \vdash el:S_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash \overline{l}:S_{2}, \env_{3} \;\;\;
       S_{1} \lesssim S_{2}}
      {\env_{1}, \penv \vdash \overline{l} = el,\env_{3}}
\]

\mylabel{T-METHOD1}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\; T_{s} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open}\\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \not \exists i \in 1..n \; L \lesssim K_{i}\\
       crall(\env_{1}[self \mapsto \Self, \overline{id} \mapsto \overline{T}, \self \mapsto T_{s}]),
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       T_{o} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}, L{:}\Const \; \Self \times \overline{T} \times \Void \rightarrow S\}_{unique|open}\\
       \env_{4} = openset(crset(\env_{1}[id_{1} \mapsto T_{o}], fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)),rv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}T}){:}S \; s, \env_{4}\\
       \end{array}}
\]

\mylabel{T-METHOD2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\; T_{s} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open}\\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \not \exists i \in 1..n \; L \lesssim K_{i}\\
       crall(\env_{1}[self \mapsto \Self, \overline{id} \mapsto \overline{T}, {...} \mapsto T, \self \mapsto T_{s}]),
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       T_{o} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}, L{:}\Const \; \Self \times \overline{T} \times T{*} \rightarrow S\}_{unique|open}\\
       \env_{4} = openset(crset(\env_{1}[id_{1} \mapsto T_{o}], fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)),rv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}T},{...}{:}T){:}S \; s, \env_{4}\\
       \end{array}}
\]

\mylabel{T-METHOD3}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\; T_{s} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open} \;\;\;
       \env_{1}, \penv \vdash id_{2} : L, \env_{2}\\
       crall(\env_{1}[self \mapsto \Self, \overline{id} \mapsto \overline{T}, \self \mapsto T_{s}]),
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       \exists i \in 1..n \; L \subtype K_{i} \wedge K_{i} \subtype L \;\;\;
       \Const \; \Self \times \overline{T} \times \Void \rightarrow S \subtype V_{i}\\
       V_{i} = \Const \; \Self \times \overline{T} \times \Void \rightarrow S\\
       T_{o} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open}\\
       \env_{4} = openset(crset(\env_{1}[id_{1} \mapsto T_{o}], fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)),rv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}T}){:}S \; s, \env_{4}\\
       \end{array}}
\]

\mylabel{T-METHOD2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = T_{s} \;\;\; T_{s} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open} \;\;\;
       \env_{1}, \penv \vdash id_{2} : L, \env_{2}\\
       crall(\env_{1}[self \mapsto \Self, \overline{id} \mapsto \overline{T}, {...} \mapsto T, \self \mapsto T_{s}]),
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       \exists i \in 1..n \; L \subtype K_{i} \wedge K_{i} \subtype L \;\;\;
       \Const \; \Self \times \overline{T} \times T{*} \rightarrow S \subtype V_{i}\\
       V_{i} = \Const \; \Self \times \overline{T} \times T{*} \rightarrow S\\
       T_{o} = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open}\\
       \env_{4} = openset(crset(\env_{1}[id_{1} \mapsto T_{o}], fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)),rv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}T},{...}{:}T){:}S \; s, \env_{4}\\
       \end{array}}
\]

\mylabel{T-WHILE1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e:T, \env_{2} \;\;\;
       closeall(\env_{2}), \penv \vdash s, \env_{3}\\
       \env_{4} = openset(closeset(\env_{2}, fav(s)),rv(s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{while} \; e \; \mathbf{do} \; s,\env_{4}}
\]

\mylabel{T-WHILE2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2}, filter(T_{1} \cup T_{2}, \Nil))]), \penv \vdash s, \env_{2}\\
       \env_{3} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s)),rv(s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{while} \; id \; \mathbf{do} \; s,\env_{3}}
\]

\mylabel{T-WHILE3}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Nil,i)] \vdash s, \env_{2}\\
       \env_{3} = openset(closeset(\env_{1}, fav(s)),rv(s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{while} \; id \; \mathbf{do} \; s,\env_{3}}
\]

\mylabel{T-IF1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e:T, \env_{2}\\
       closeall(\env_{2}), \penv \vdash s_{1}:\env_{3} \\
       closeall(\env_{2}), \penv \vdash s_{2}:\env_{4} \\
       \env_{5} = openset(closeset(\env_{2}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2})))
       \end{array}}
      {\env_{1} \vdash \mathbf{if} \; e \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{5}}
\]

\mylabel{T-IF2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \Nil))]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\Nil)]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF3}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Nil,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\Nil,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF4}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\Boolean)]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \Boolean))]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``boolean" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF5}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\Boolean,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Boolean,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``boolean" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF6}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\Integer)]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \Integer))]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``integer" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF7}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\Integer,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Integer,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``integer" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF8}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\Number)]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \Number))]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``number" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF9}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\Number,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\Number,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``number" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF10}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T_{1} \cup T_{2}\\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},\String)]), \penv \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}[id \mapsto \phi(T_{1} \cup T_{2},filter(T_{1} \cup T_{2}, \String))]), \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = openset(closeset(\env_{1}[id \mapsto T_{1} \cup T_{2}], fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``string" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF11}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \;\;\; \penv(x) = S\\
       closeall(\env_{1}), \penv[x \mapsto gpt(S,\String,i)] \vdash s_{1}, \env_{2} \\
       closeall(\env_{1}), \penv[x \mapsto fpt(S,\String,i)] \vdash s_{2}, \env_{3} \\
       \env_{4} = openset(closeset(\env_{1}, fav(s_{1}) \cup fav(s_{2})),rv(s_{1}) \cup rv(s_{2}))
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``string" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-LOCAL1}
\[
\dfrac{\env_{1}, \penv \vdash el:S, \env_{2} \;\;\;
       S \lesssim \overline{T} \times \Value{*} \;\;\;
       \env_{2}[\overline{id} \mapsto \overline{T}], \penv \vdash s, \env_{3}}
      {\env_{1}, \penv \vdash \mathbf{local} \; \overline{id{:}T} = el \; \mathbf{in} \; s, \env_{3} - \{\overline{id}\}}
\]

\mylabel{T-LOCAL2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash el:S_{1}, \env_{2}, (x,S_{2})\\
       \env_{2}[id_{1} \mapsto infer(S_{1},1), ..., id_{n} \mapsto infer(S_{1},n)], \penv[x \mapsto S_{2}] \vdash s, \env_{3} \;\;\;
       n = |\;\overline{id}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{local} \; \overline{id} = el \; \mathbf{in} \; s, \env_{3} - \{\overline{id}\}}
\]

\mylabel{T-LOCALREC}
\[
\dfrac{\env_{1}[id \mapsto T], \penv \vdash f:T_{1}, \env_{2} \;\;\;
       T_{1} \lesssim T \;\;\;
       \env_{2}, \penv \vdash s, \env_{3}}
      {\env_{1}, \penv \vdash \mathbf{rec} \; id{:}T = f \; \mathbf{in} \; s, \env_{3} - \{id\}}
\]

\mylabel{T-RETURN}
\[
\dfrac{\env_{1} \vdash el:S_{1}, \env_{2} \;\;\;
       \penv(\ret) = S_{2} \;\;\;
       S_{1} \lesssim S_{2}}
      {\env_{1} \vdash \mathbf{return} \; el, \env_{2}}
\]

\mylabel{T-STMAPPLY1}
\[
\dfrac{\env_{1}, \penv \vdash e(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e(el) \rfloor_{0},\env_{2}}
\]

\mylabel{T-STMINVOKE1}
\[
\dfrac{\env_{1}, \penv \vdash e{:}n(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e{:}n(el) \rfloor_{0}, \env_{2}}
\]

\mylabel{T-NIL}
\[
\env_{1}, \penv \vdash \mathbf{nil}:\Nil, \env_{1}
\]

\mylabel{T-FALSE}
\[
\env_{1}, \penv \vdash \mathbf{false}:\False, \env_{1}
\]

\mylabel{T-TRUE}
\[
\env_{1}, \penv \vdash \mathbf{true}:\True, \env_{1}
\]

\mylabel{T-INT}
\[
\env_{1}, \penv \vdash {\it int}:{\it int}, \env_{1}
\]

\mylabel{T-FLOAT}
\[
\env_{1}, \penv \vdash {\it float}:{\it float}, \env_{1}
\]

\mylabel{T-STR}
\[
\env_{1}, \penv \vdash {\it string}:{\it string}, \env_{1}
\]

\mylabel{T-IDREAD1}
\[
\dfrac{\env_{1}(id) = T_{1} \;\;\; T_{2} = read(\penv, T_{1})}
      {\env_{1}, \penv \vdash id:close(T_{2}), \env_{1}[id \mapsto open(T_{1})]}
\]

\mylabel{T-IDREAD2}
\[
\dfrac{\env_{1}(id) = T_{1} \;\;\; T_{2} = read(\penv, T_{1})}
      {\env_{1}, \penv \vdash id:fix(T_{2}), \env_{1}[id \mapsto fix(T_{1})]}
\]

\mylabel{T-INDEX1}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = T \;\;\;
       read(\penv, T) = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}\\
       \env_{1}, \penv \vdash e_{2}:K, \env_{2} \;\;\;
       \exists i \in 1{..}n \; K \lesssim K_{i}
       \end{array}}
      {\env_{1}, \penv \vdash id[e_{2}]:V_{i}, \env_{2}}
\]

\mylabel{T-INDEX2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{1}:\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}, \env_{2}\\
       \env_{2}, \penv \vdash e_{2}:K, \env_{3} \;\;\;
       \exists i \in 1{..}n \; K \lesssim K_{i}
       \end{array}}
      {\env_{1}, \penv \vdash e_{1}[e_{2}]:V_{i}, \env_{3}}
\]

\mylabel{T-INDEX3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:t, \env_{3}}
      {\env_{1}, \penv \vdash e_{1}[e_{2}]:\Any, \env_{3}}
\]

\mylabel{T-COERCE}
\[
\dfrac{\env_{1}(id) \subtype T \;\;\;
       \env_{1}[id \mapsto T], \penv \vdash id:T_{1}, \env_{2}}
      {\env_{1}, \penv \vdash {<}T{>} \; id:T_{1}, \env_{2}}
\]

\mylabel{T-FUNCTION1}
\[
\dfrac{\begin{array}{c}
       crall(\env_{1}[\overline{id} \mapsto \overline{T}]), \penv[\ret \mapsto S] \vdash s, \env_{2}\\
       \env_{3} = openset(crset(\env_{1}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)),rv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{fun} \; (\overline{id{:}T}){:}S \; s:\overline{T} \times \Void \rightarrow S, \env_{3}}
\]

\mylabel{T-FUNCTION2}
\[
\dfrac{\begin{array}{c}
       crall(\env_{1}[\overline{id} \mapsto \overline{T}, {...} \mapsto T]), \penv[\ret \mapsto S] \vdash s, \env_{2}\\
       \env_{3} = openset(crset(\env_{1}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)),rv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{fun} \; (\overline{id{:}T},{...}{:}T){:}S \; s:\overline{T} \times T{*} \rightarrow S, \env_{3}}
\]

\mylabel{T-CONSTRUCTOR1}
\[
\env_{1}, \penv \vdash \{\}:\{\}_{unique}, \env_{1}
\]

\mylabel{T-CONSTRUCTOR2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash ([e_{1}] = e_{2})_{i}:(K_{i},V_{i}), \env_{i+1} \\
       T = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique} \;\;\;
       wf(T) \;\;\;
       n = |\;\overline{[e_{1}] = e_{2}}\;| \\
       \env_{m} = merge(\env_{1}, ..., \env_{n+1})
       \end{array}}
      {\env_{1}, \penv \vdash \{\;\overline{[e_{1}] = e_{2}}\;\}:T, \env_{m}}
\]

\mylabel{T-CONSTRUCTOR3}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash ([e_{1}] = e_{2})_{i}:(K_{i},V_{i}), \env_{i+1} \\
       \env_{1}, \penv \vdash me : T_{1} \times ... \times T_{m} \times T_{m+1}{*}, \env_{n+2}\\
       T = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}, 1:T_{1}, ..., m:T_{m}, \Integer:T_{m+1} \cup \Nil\}_{unique}\\
       wf(T) \;\;\;
       n = |\;\overline{[e_{1}] = e_{2}}\;| \;\;\;
       \env_{m} = merge(\env_{1}, ..., \env_{n+2})
       \end{array}}
      {\env_{1}, \penv \vdash \{\;\overline{[e_{1}] = e_{2}}\;\}:T, \env_{m}}
\]

\mylabel{T-FIELD1}
\[
\dfrac{\env_{1}, \penv \vdash e_{2}:T_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{1}:T_{1}, \env_{3} \;\;\;
       T_{1} \subtype \Boolean}
      {\env_{1}, \penv \vdash [e_{1}] = e_{2}: (T_{1},close(T_{2})), \env_{3}}
\]

\mylabel{T-FIELD2}
\[
\dfrac{\env_{1}, \penv \vdash e_{2}:T_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{1}:T_{1}, \env_{3} \;\;\;
       T_{1} \subtype \Number}
      {\env_{1}, \penv \vdash [e_{1}] = e_{2}: (T_{1},close(T_{2})), \env_{3}}
\]

\mylabel{T-FIELD3}
\[
\dfrac{\env_{1}, \penv \vdash e_{2}:T_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{1}:T_{1}, \env_{3} \;\;\;
       T_{1} \subtype \String}
      {\env_{1}, \penv \vdash [e_{1}] = e_{2}: (T_{1},close(T_{2})), \env_{3}}
\]

\mylabel{T-FIELD4}
\[
\dfrac{\env_{1}, \penv \vdash e_{2}:T_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{1}:T_{1}, \env_{3}}
      {\env_{1}, \penv \vdash [e_{1}] = e_{2}: (\Value,close(T_{2})), \env_{3}}
\]

\mylabel{T-ARITH1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Integer \;\;\;
       T_{2} \subtype \Integer}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Integer, \env_{3}}
\]

\mylabel{T-ARITH2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Integer \;\;\;
       T_{2} \subtype \Number}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Number \;\;\;
       T_{2} \subtype \Integer}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Number \;\;\;
       T_{2} \subtype \Number}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH5}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Any, \env_{3}}
\]

\mylabel{T-ARITH6}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Any, \env_{3}}
\]

\mylabel{T-CONCAT1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \String \;\;\;
       T_{2} \subtype \String}
      {\env_{1}, \penv \vdash e_{1} \; {..} \; e_{2}:\String, \env_{3}}
\]

\mylabel{T-CONCAT2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; {..} \; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-CONCAT3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; {..} \; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-EQUAL}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} == e_{2}:\Boolean, \env_{3}}
\]

\mylabel{T-ORDER1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Number \;\;\;
       T_{2} \subtype \Number}
      {\env, \penv \vdash e_{1} < e_{2}:\Boolean, \env_{3}}
\]

\mylabel{T-ORDER2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \String \;\;\;
       T_{2} \subtype \String}
      {\env_{1}, \penv \vdash e_{1} < e_{2}:\Boolean}
\]

\mylabel{T-ORDER3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} < e_{2}:\Any, \env_{3}}
\]

\mylabel{T-ORDER4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} < e_{2}:\Any, \env_{3}}
\]

\mylabel{T-BITWISE1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       T_{1} \subtype \Integer \;\;\;
       T_{2} \subtype \Integer}
      {\env_{1}, \penv \vdash e_{1} \;\&\; e_{2}:\Integer, \env_{3}}
\]

\mylabel{T-BITWISE2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \;\&\; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-BITWISE3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \;\&\; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-AND1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil, \env_{2}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:\Nil, \env_{2}}
\]

\mylabel{T-AND2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\False, \env_{2}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:\False, \env_{2}}
\]

\mylabel{T-AND3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil \cup \False, \env_{2}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:\Nil \cup \False, \env_{2}}
\]

\mylabel{T-AND4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       \Nil \not\lesssim T_{1} \;\;\;
       \False \not\lesssim T_{1}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:T_{2}, \env_{3}}
\]

\mylabel{T-AND5}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:T_{1} \cup T_{2}, \env_{3}}
\]

\mylabel{T-OR1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T, \env_{2} \;\;\;
       \Nil \not\lesssim T \;\;\;
       \False \not\lesssim T}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:T, \env_{2}}
\]

\mylabel{T-OR2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:T, \env_{3}}
\]

\mylabel{T-OR3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\False, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:T, \env_{3}}
\]

\mylabel{T-OR4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil \cup \False, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:T, \env_{3}}
\]

\mylabel{T-OR5}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:filter(filter(T_{1}, \Nil), \False) \cup T_{2}, \env_{3}}
\]

\mylabel{T-NOT1}
\[
\dfrac{\env_{1}, \penv \vdash e:\Nil, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\True, \env_{2}}
\]

\mylabel{T-NOT2}
\[
\dfrac{\env_{1}, \penv \vdash e:\False, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\True, \env_{2}}
\]

\mylabel{T-NOT3}
\[
\dfrac{\env_{1}, \penv \vdash e:\Nil \cup \False, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\True, \env_{2}}
\]

\mylabel{T-NOT4}
\[
\dfrac{\env_{1}, \penv \vdash e:T \;\;\;
       \Nil \not\lesssim T \;\;\;
       \False \not\lesssim T}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\False, \env_{2}}
\]

\mylabel{T-NOT5}
\[
\dfrac{\env_{1}, \penv \vdash e:T, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\Boolean, \env_{2}}
\]

\mylabel{T-LEN1}
\[
\dfrac{\env_{1}, \penv \vdash e:T, \env_{2} \;\;\;
       T \subtype \String}
      {\env_{1}, \penv \vdash \# \; e:\Integer, \env_{2}}
\]

\mylabel{T-LEN2}
\[
\dfrac{\env_{1}, \penv \vdash e:T, \env_{2} \;\;\;
       T \subtype \{\}_{closed}}
      {\env_{1}, \penv \vdash \# \; e:\Integer, \env_{2}}
\]

\mylabel{T-LEN3}
\[
\dfrac{\env_{1}, \penv \vdash e:\Any, \env_{2}}
      {\env_{1}, \penv \vdash \# \; e:\Any, \env_{2}}
\]

\mylabel{T-EXPAPPLY1}
\[
\dfrac{\env_{1}, \penv \vdash e(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e(el) \rfloor_{1}:first(S), \env_{2}}
\]

\mylabel{T-EXPINVOKE1}
\[
\dfrac{\env_{1}, \penv \vdash e{:}n(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e{:}n(el) \rfloor_{1}:first(S), \env_{2}}
\]

\mylabel{T-EXPDOTS}
\[
\dfrac{\env_{1}, \penv \vdash {...}:T{*}, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor {...} \rfloor_{1}:T \cup \Nil, \env_{2}}
\]

\mylabel{T-IDWRITE}
\[
\dfrac{\env_{1}(id) = T_{1} \;\;\; T_{2} = write(T_{1})}
      {\env_{1}, \penv \vdash id_{l}:close(T_{2}), \env_{1}[id \mapsto close(T_{2})]}
\]

\mylabel{T-REFINE}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \{ K_{1}{:}V_{1}, ..., K_{n}{:}V_{n} \}_{open|unique}\\
       \env_{1}, \penv \vdash k:K, \env_{2} \;\;\;
       \not \exists i \in 1..n \; K \lesssim K_{i} \;\;\;
       V = close(T)
       \end{array}}
      {\env_{1}, \penv \vdash id[k] {<}T{>}:V, \env_{2}[id \mapsto \{ K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}, K{:}V\}_{open|unique}]}
\]

\mylabel{T-LHSLIST}
\[
\dfrac{\env_{1}, \penv \vdash l_{i}:T_{i}, \env_{i+1} \;\;\;
       \env_{m} = merge(\env_{1}, ..., \env_{n+1}) \;\;\;
       n = |\;\overline{l}\;|}
      {\env_{1}, \penv \vdash \overline{l}:T_{1} \times ... \times T_{n} \times \Value{*}, \env_{m}}
\]

\mylabel{T-EXPLIST1}
\[
\dfrac{\env_{1}, \penv \vdash e_{i}:T_{i}, \env_{i+1} \;\;\;
       \env_{m} = merge(\env_{1}, ..., \env_{n+1}) \;\;\;
       n = |\;\overline{e}\;|}
      {\env_{1}, \penv \vdash \overline{e}:T_{1} \times ... \times T_{n} \times \Nil{*}, \env_{m}}
\]

\mylabel{T-EXPLIST2}
\[
\dfrac{\env_{1}, \penv \vdash me:T_{1} \times ... \times T_{n} \times \Void, \env_{2}}
      {\env_{1}, \penv \vdash me:T_{1} \times ... \times T_{n} \times \Nil{*}, \env_{2}}
\]

\mylabel{T-EXPLIST3}
\[
\dfrac{\env_{1}, \penv \vdash me:T_{1} \times ... \times T_{n}{*}, \env_{2}}
      {\env_{1}, \penv \vdash me:T_{1} \times ... \times T_{n}{*}, \env_{2}}
\]

\mylabel{T-EXPLIST4}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{i}:T_{i}, \env_{i+1} \;\;\;
       \env_{1}, \penv \vdash me:T_{n+1} \times ... \times T_{m} \times \Void, \env_{n+2}\\
       \env_{m} = merge(\env_{1}, ..., \env_{n+2}) \;\;\;
       n = |\;\overline{e}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \overline{e},me:T_{1} \times ... \times T_{m} \times \Nil{*}, \env_{m}}
\]

\mylabel{T-EXPLIST5}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{i}:T_{i}, \env_{i+1} \;\;\;
       \env_{1}, \penv \vdash me:T_{n+1} \times ... \times T_{m}{*}, \env_{n+2}\\
       \env_{m} = merge(\env_{1}, ..., \env_{n+2}) \;\;\;
       n = |\;\overline{e}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \overline{e},me:T_{1} \times ... \times T_{m}{*}, \env_{m}}
\]

\mylabel{T-EXPLIST6}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash me:S, \env_{2}\\
       S = T_{1} \times ... \times T_{n} \times \Void \sqcup T_{1}' \times ... \times T_{n}' \times \Void
       \end{array}}
      {\env_{1}, \penv \vdash me:\pi_{1}^{x} \times ... \times \pi_{n}^{x} \times \Nil{*}, \env_{2}, (x,S)}
\]

\mylabel{T-APPLY1}
\[
\dfrac{\env_{1}, \penv \vdash e:S_{1} \rightarrow S_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash el:S_{3}, \env_{3} \;\;\;
       S_{3} \lesssim S_{1}}
      {\env_{1}, \penv \vdash e(el):S_{2}, \env_{3}}
\]

\mylabel{T-APPLY2}
\[
\dfrac{\env_{1}, \penv \vdash e:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash el:S, \env_{3}}
      {\env_{1}, \penv \vdash e_{1}(el):\Any{*}, \env_{3}}
\]

\mylabel{T-INVOKE1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e:T_{s}, \env_{2}\\
       \env_{2}[\sigma \mapsto T_{s}], \penv \vdash e[id]:\Const \; S_{1} \rightarrow S_{2}, \env_{3}\\
       \env_{3}[\sigma \mapsto T_{s}], \penv \vdash el:S_{3}, \env_{4} \;\;\;
       T_{s} \times S_{3} \lesssim S_{1}
       \end{array}}
      {\env_{1}, \penv \vdash e{:}id(el):[\sigma \mapsto T]S_{2}, \env_{4}}
\]

\mylabel{T-INVOKE2}
\[
\dfrac{\env_{1}, \penv \vdash e:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash el:S, \env_{3}}
      {\env_{1}, \penv \vdash e{:}id(el):\Any{*}, \env_{3}}
\]

\mylabel{T-DOTS}
\[
\dfrac{\env_{1}({...}) = T}
      {\env_{1}, \penv \vdash {...}:T{*}, \env_{1}}
\]

\mylabel{T-SELF}
\[
\dfrac{\env_{1}, \penv \vdash e:\Self, \env_{2} \;\;\;
       \env_{2}(\self) = T}
      {\env_{1}, \penv \vdash e:T, \env_{2}}
\]

\mylabel{T-SETMETATABLE1}
\[
\dfrac{\env(id) = \Self}
      {\env, \penv \vdash setmetatable(\{\}, \{[``\string_\string_index"] = id\}):\Self, \env}
\]

\mylabel{T-SETMETATABLE2}
\[
\dfrac{\env(id) = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{fixed}}
      {\env, \penv \vdash setmetatable(\{\}, \{[``\string_\string_index"] = id\}):\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{open}, \env}
\]

\mylabel{T-SETMETATABLE3}
\[
\dfrac{\env_{1}, \penv \vdash e = T, \env_{2} \;\;\;
       T = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{closed} \;\;\;
       \env_{1}(id) = \Self \;\;\; \env_{1}(\sigma) \subtype T}
      {\env_{1}, \penv \vdash setmetatable(e, \{[``\string_\string_index"] = id\}):\Self, \env_{2}[\sigma \mapsto T]}
\]

\mylabel{T-UNFOLD}
\[
\dfrac{\env_{1}, \penv \vdash e:\mu x.T, \env_{2}}
      {\env_{1}, \penv \vdash e:[x \mapsto \mu x.T]T, \env_{2}}
\]

\mylabel{T-FOLD}
\[
\dfrac{\env_{1}, \penv \vdash e:[x \mapsto \mu x.T]T, \env_{2}}
      {\env_{1}, \penv \vdash e:\mu x.T, \env_{2}}
\]

\mylabel{T-TERNARY}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:T_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:T_{2}, \env_{3} \;\;\;
       \env_{3}, \penv \vdash e_{3}:T_{2}, \env_{4}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2} \; \mathbf{or} \; e_{3}:T_{2}, \env_{4}}
\]

\section{Auxiliary functions}

\noindent

\begin{align*}
first(\Void) & = \Nil\\
first(T{*}) & = T \cup \Nil\\
first(T \times P) & = T\\
first(S_{1} \sqcup S_{2}) & = first(S_{1}) \cup first(S_{2})
\\ \\
read(\penv, \phi(T_{1},T_{2})) & = T_{2}\\
read(\penv, \pi_{i}^{x}) & = proj(\penv(x), i)\\
read(\penv, T) & = T
\\ \\
write(\phi(T_{1},T_{2})) & = T_{1}\\
write(T) & = T
\\ \\
infer(T_{1} \times ... \times T_{n}{*}, i) & = \left\{
\begin{array}{ll}
general(T_{i}) & \text{if $i < n$}\\
general(T_{n} \cup \Nil) & \text{if $i >= n$}
\end{array} \right.
\\ \\
general(\False) & = \Boolean\\
general(\True) & = \Boolean\\
general({\it int}) & = \Integer\\
general({\it float}) & = \Number\\
general({\it string}) & = \String\\
general(T_{1} \cup T_{2}) & = general(T_{1}) \cup general(T_{2})\\
general(S_{1} \rightarrow S_{2}) & = general2(S_{1}) \rightarrow general2(S_{2})\\
general(\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{tag}) & = \{K_{1}{:}general(V_{1}), ..., K_{n}{:}general(V_{n})\}_{tag}\\
general(\mu x.T) & = \mu x.general(T)\\
general(T) & = T\\
\\
general2(\Void) & = \Void\\
general2(T{*}) & = general(T){*}\\
general2(T \times P) & = general(T) \times general2(P)\\
general2(S_{1} \sqcup S_{2}) & = general2(S_{1}) \sqcup general2(S_{2})
\\ \\
proj(T_{1} \times ... \times T_{n} \times T{*}, i) & =  T_{i} \;\;\; \text{if $i <= n$}\\
proj(S_{1} \sqcup S_{2}, i) & = proj(S_{1}, i) \cup proj(S_{2}, i)
\\ \\
filter(T_{1} \cup T_{2}, T_{1}) & = filter(T_{2}, T_{1})\\
filter(T_{1} \cup T_{2}, T_{2}) & = filter(T_{1}, T_{2})\\
filter(T_{1} \cup T_{2}, T_{3}) & = filter(T_{1}, T_{3}) \cup filter(T_{2}, T_{3})\\
filter(T_{1}, T_{2}) & = T_{1}
\\ \\
close(T_{1} \cup T_{2}) & = close(T_{1}) \cup close(T_{2})\\
close(\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open}) & = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{closed} \\
close(T) & = T
\\ \\
fix(T_{1} \cup T_{2}) & = fix(T_{1}) \cup fix(T_{2})\\
fix(\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique|open}) & = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{fixed} \\
fix(T) & = T
\\ \\
open(T_{1} \cup T_{2}) & = open(T_{1}) \cup open(T_{2})\\
open(\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{unique}) & = \{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}\}_{open} \\
open(T) & = T
\end{align*}

\begin{align*}
fpt(T_{1} \times .... \times T_{n}{*} \sqcup T_{1}' \times ... \times T_{n}'{*}, T, i) & = T_{1}' \times ... \times T_{n}'{*}
\end{align*}

\begin{align*}
gpt(T_{1} \times .... \times T_{n}{*} \sqcup T_{1}' \times ... \times T_{n}'{*}, T, i) & = T_{1} \times ... \times T_{n}{*}
\end{align*}

\begin{align*}
closeall(\env[id_{1} \mapsto T_{1}, ..., id_{n} \mapsto T_{n}]) & = \env[id_{1} \mapsto close(T_{1}), ..., id_{n} \mapsto close(T_{n})]
\end{align*}

\begin{align*}
crall(\env[id_{1} \mapsto T_{1}, ..., id_{n} \mapsto T_{n}]) & = \env[id_{1} \mapsto close(write(T_{1})), ..., id_{n} \mapsto close(write(T_{n}))]
\end{align*}

\begin{align*}
closeset(\env, \{id_{1}, ..., id_{n}\}) & = \env[id_{1} \mapsto close(\env(id_{1})), ..., id_{n} \mapsto close(\env(id_{n}))]
\end{align*}

\begin{align*}
crset(\env, \{id_{1}, ..., id_{n}\}) & = \env[id_{1} \mapsto close(write(\env(id_{1}))), ..., id_{n} \mapsto close(write(\env(id_{n})))]
\end{align*}

\begin{align*}
openset(\env, \{id_{1}, ..., id_{n}\}) & = \env[id_{1} \mapsto open(\env(id_{1})), ..., id_{n} \mapsto open(\env(id_{n}))]
\end{align*}

\begin{align*}
merge(\env_{1}[id_{1} \mapsto T_{1}, ..., id_{n} \mapsto T_{n}], \env_{2}[id_{1} \mapsto T_{1}', ..., id_{n} \mapsto T_{n}']) & =\\
\env_{3}[id_{1} \mapsto merget(T_{1}, T_{1}'), ..., id_{n} \mapsto merget(T_{n}, T_{n}')]
\end{align*}

\begin{align*}
merget(\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}, K{:}V\}_{tag},\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}, K'{:}V'\}_{tag}) & = \\
\{K_{1}{:}V_{1}, ..., K_{n}{:}V_{n}, K{:}V, K'{:}V'\}_{tag}\\
merget(T,T') & = T' \; \text{if \; $T \subtype T'$}
\end{align*}

\begin{align*}
fav(\mathbf{skip}) & = \emptyset\\
fav(s_{1} \;;\; s_{2}) & = fav(s_{1}) \cup fav(s_{2})\\
fav(\overline{l} = el) & = fav(\overline{l}) \cup fav(el)\\
fav(\mathbf{while} \; e \; \mathbf{do} \; s) & = fav(s)\\
fav(\mathbf{if} \; e \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}) & = fav(s_{1}) \cup fav(s_{2})\\
fav(\mathbf{local} \; \overline{id{:}T} = el \; \mathbf{in} \; s) & = fav(s)\\
fav(\mathbf{local} \; \overline{id} = el \; \mathbf{in} \; s) & = fav(el) \cup fav(s)\\
fav(\mathbf{rec} \; id{:}T = f \; \mathbf{in} \; s) & = fav(f) \cup fav(s)\\
fav(\mathbf{return} \; el) & = fav(el)\\
fav(\lfloor a \rfloor_{0}) & = fav(a)\\
fav(\mathbf{fun} \; id_{1}{:}id_{2} \; (pl){:}S \; s \;;\; \mathbf{return} \; el) & = fav(s) \cup fav(el)\\
fav(\mathbf{nil}) & = \emptyset\\
fav(k) & = \emptyset\\
fav(id) & = \emptyset\\
fav(e_{1}[e_{2}]) & = \emptyset\\
fav({<}T{>} \; id) & = \emptyset\\
fav(\mathbf{fun} \; (pl){:}S \; s \;;\; \mathbf{return} \; el) & = fav(s) \cup fav(el)\\
fav(\{ \; \overline{[e_{1}] = e_{2}} \; \}) & = fav(\overline{e_{1}}) \cup fav(\overline{e_{2}})\\
fav(\{ \; \overline{[e_{1}] = e_{2}},me \; \}) & = fav(\overline{e_{1}}) \cup fav(\overline{e_{2}}) \cup fav(me)\\
fav(e_{1} + e_{2}) & = fav(e_{1}) \cup fav(e_{2})\\
fav(e_{1} \; {..} \; e_{2}) & = fav(e_{1}) \cup fav(e_{2})\\
fav(e_{1} == e_{2}) & = fav(e_{1}) \cup fav(e_{2})\\
fav(e_{1} < e_{2}) & = fav(e_{1}) \cup fav(e_{2})\\
fav(e_{1} \;\&\; e_{2}) & = fav(e_{1}) \cup fav(e_{2})\\
fav(e_{1} \; \mathbf{and} \; e_{2}) & = fav(e_{1}) \cup fav(e_{2})\\
fav(e_{1} \; \mathbf{or} \; e_{2}) & = fav(e_{1}) \cup fav(e_{2})\\
fav(\mathbf{not} \; e) & = fav(e)\\
fav(\# \; e) & = fav(e)\\
fav(\lfloor me \rfloor_{1}) & = fav(me)\\
fav(id_{l}) & = \{ id \}\\
fav(id[k] \; {<}T{>}) & = \emptyset\\
fav(e(el)) & = fav(e) \cup fav(el)\\
fav(e{:}n(el)) & = fav(e) \cup fav(el)\\
fav({...}) & = \emptyset
\end{align*}

\begin{align*}
rv(\mathbf{skip}) & = \emptyset\\
rv(s_{1} \;;\; s_{2}) & = rv(s_{1}) \cup rv(s_{2})\\
rv(\overline{l} = el) & = rv(\overline{l}) \cup rv(el)\\
rv(\mathbf{while} \; e \; \mathbf{do} \; s) & = rv(e) \cup rv(s)\\
rv(\mathbf{if} \; e \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}) & = rv(e) \cup rv(s_{1}) \cup rv(s_{2})\\
rv(\mathbf{local} \; \overline{id{:}T} = el \; \mathbf{in} \; s) & = rv(el) \cup rv(s)\\
rv(\mathbf{local} \; \overline{id} = el \; \mathbf{in} \; s) & = rv(el) \cup rv(s)\\
rv(\mathbf{rec} \; id{:}T = f \; \mathbf{in} \; s) & = rv(f) \cup rv(s)\\
rv(\mathbf{return} \; el) & = rv(el)\\
rv(\lfloor a \rfloor_{0}) & = rv(a)\\
rv(\mathbf{fun} \; id_{1}{:}id_{2} \; (pl){:}S \; s \;;\; \mathbf{return} \; el) & = rv(s) \cup rv(el)\\
rv(\mathbf{nil}) & = \emptyset\\
rv(k) & = \emptyset\\
rv(id) & = \{ id \}\\
rv(e_{1}[e_{2}]) & = \emptyset\\
rv({<}T{>} \; id) & = \emptyset\\
rv(\mathbf{fun} \; (pl){:}S \; s \;;\; \mathbf{return} \; el) & = rv(s) \cup rv(el)\\
rv(\{ \; \overline{[e_{1}] = e_{2}} \; \}) & = rv(\overline{e_{1}}) \cup rv(\overline{e_{2}})\\
rv(\{ \; \overline{[e_{1}] = e_{2}},me \; \}) & = rv(\overline{e_{1}}) \cup rv(\overline{e_{2}}) \cup rv(me)\\
rv(e_{1} + e_{2}) & = rv(e_{1}) \cup rv(e_{2})\\
rv(e_{1} \; {..} \; e_{2}) & = rv(e_{1}) \cup rv(e_{2})\\
rv(e_{1} == e_{2}) & = rv(e_{1}) \cup rv(e_{2})\\
rv(e_{1} < e_{2}) & = rv(e_{1}) \cup rv(e_{2})\\
rv(e_{1} \;\&\; e_{2}) & = rv(e_{1}) \cup rv(e_{2})\\
rv(e_{1} \; \mathbf{and} \; e_{2}) & = rv(e_{1}) \cup rv(e_{2})\\
rv(e_{1} \; \mathbf{or} \; e_{2}) & = rv(e_{1}) \cup rv(e_{2})\\
rv(\mathbf{not} \; e) & = rv(e)\\
rv(\# \; e) & = rv(e)\\
rv(\lfloor me \rfloor_{1}) & = rv(me)\\
rv(id_{l}) & = \emptyset\\
rv(id[k] \; {<}T{>}) & = \emptyset\\
rv(e(el)) & = rv(e) \cup rv(el)\\
rv(e{:}n(el)) & = rv(e) \cup rv(el)\\
rv({...}) & = \emptyset
\end{align*}


