\documentclass{paper}

\usepackage[utf8]{inputenc}
\usepackage[square,semicolon]{natbib}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{url}
\usepackage{color}

\newcommand{\Value}{\mathbf{value}}
\newcommand{\Any}{\mathbf{any}}
\newcommand{\Nil}{\mathbf{nil}}
\newcommand{\Self}{\mathbf{self}}
\newcommand{\False}{\mathbf{false}}
\newcommand{\True}{\mathbf{true}}
\newcommand{\Boolean}{\mathbf{boolean}}
\newcommand{\Number}{\mathbf{number}}
\newcommand{\String}{\mathbf{string}}
\newcommand{\Void}{\mathbf{void}}
\newcommand{\Const}{\mathbf{const}}

\newcommand{\mylabel}[1]{\; (\textsc{#1})}
\newcommand{\env}{\Gamma}
\newcommand{\senv}{\Sigma}
\newcommand{\subtype}{<:}
\newcommand{\ret}{\rho}

\def\dstart{\hbox to \hsize{\vrule depth 4pt\hrulefill\vrule depth 4pt}}
\def\dend{\hbox to \hsize{\vrule height 4pt\hrulefill\vrule height 4pt}}

\begin{document}

\section{Types}

\begin{figure}[!ht]
\textbf{Type Language}\\
\dstart
$$
\begin{array}{rlr}
\multicolumn{3}{c}{\textbf{First-level types}}\\
t ::= & \;\; l & \textit{literal types}\\
& | \; b & \textit{base types}\\
& | \; \Nil & \textit{nil type}\\
& | \; \Value & \textit{top type}\\
& | \; \Any & \textit{dynamic type}\\
& | \; \Self & \textit{self type}\\
& | \; t \cup t & \textit{disjoint union types}\\
& | \; p \rightarrow r & \textit{function types}\\
& | \; \{v_{i}, ..., v_{n}\}_{c|o|u} & \textit{table types}\\
& | \; x & \textit{type variables}\\
& | \; \mu x.t & \textit{recursive types}\\
& | \; x_{i} & \textit{projection types}\\
l ::= & \False \; | \; \True \; | \; {\it number} \; | \; {\it string} & \\
b ::= & \Boolean \; | \; \Number \; | \; \String & \\
v ::= & k:t \; | \; \Const \; k:t & \textit{field types}\\ 
k ::= & l \; | \; b \; | \; \Any & \textit{key types}\\
\multicolumn{3}{c}{}\\
\multicolumn{3}{c}{\textbf{Second-level types}}\\
s ::= & \;\; t &\\
& | \; t* & \textit{variadic types}\\
& | \; t \times s & \textit{tuple types}\\
p ::= & \Void \; | \; s & \textit{parameters list type}\\
r ::= & \Void \; | \; s \; | \; s \sqcup r & \textit{return types}\\
\end{array}
$$
\dend
\caption{The abstract syntax of Typed Lua types}
\label{fig:typelang}
\end{figure}

\section{Subtyping}

\noindent

\mylabel{S-LITERAL}
\[
\senv \vdash l \subtype l
\]

\mylabel{S-FALSE}
\[
\senv \vdash \False \subtype \Boolean
\]

\mylabel{S-TRUE}
\[
\senv \vdash \True \subtype \Boolean
\]

\mylabel{S-NUMBER}
\[
\senv \vdash {\it number} \subtype \Number
\]

\mylabel{S-STRING}
\[
\senv \vdash {\it string} \subtype \String
\]

\mylabel{S-BASE}
\[
\senv \vdash b \subtype b
\]

\mylabel{S-NIL}
\[
\senv \vdash \Nil \subtype \Nil
\]

\mylabel{S-VALUE}
\[
\senv \vdash t \subtype \Value
\]

\mylabel{S-ANY}
\[
\senv \vdash \Any \subtype \Any
\]

\mylabel{S-SELF}
\[
\senv \vdash \Self \subtype \Self
\]

\mylabel{S-UNION1}
\[
\dfrac{\senv \vdash t_{1} \subtype t \;\;\;
       \senv \vdash t_{2} \subtype t}
      {\senv \vdash t_{1} \cup t_{2} \subtype t}
\]

\mylabel{S-UNION2}
\[
\dfrac{\senv \vdash t \subtype t_{1}}
      {\senv \vdash t \subtype t_{1} \cup t_{2}}
\]

\mylabel{S-UNION3}
\[
\dfrac{\senv \vdash t \subtype t_{2}}
      {\senv \vdash t \subtype t_{1} \cup t_{2}}
\]

\mylabel{S-FUNCTION}
\[
\dfrac{\senv \vdash p_{2} \subtype p_{1} \;\;\;
       \senv \vdash r_{1} \subtype r_{2}}
      {\senv \vdash p_{1} \rightarrow r_{1} \subtype p_{2} \rightarrow r_{2}}
\]

\mylabel{S-TABLE1}
\[
\dfrac{\forall i \in 1..n \; \exists j \in 1..m \;\;\;
       \senv \vdash v_{j} \subtype v_{i}}
      {\senv \vdash \{v_{1}, ..., v_{m}\}_{c} \subtype \{v_{1}, ..., v_{n}\}}
\]

\mylabel{S-TABLE2}
\[
\dfrac{\forall i \in 1..m \; \senv \vdash v_{i}' \subtype v_{i}}
      {\senv \vdash \{v_{1}, ..., v_{m}\}_{o} \subtype \{v_{1}', ..., v_{m}', ..., v_{n}'\}}
\]

\mylabel{S-TABLE3}
\[
\dfrac{\forall i \in 1..m \; \senv \vdash v \subtype v_{i}}
      {\senv \vdash \{v_{1}, ..., v_{m}\}_{o} \subtype \{v\}} 
\]

\mylabel{S-FIELD1}
\[
\dfrac{\senv \vdash k_{2} \subtype k_{1} \;\;\;
       \senv \vdash t_{1} \subtype t_{2} \;\;\;
       \senv \vdash t_{2} \subtype t_{1}}
      {\senv \vdash k_{1}:t_{1} \subtype k_{2}:t_{2}}
\]

\mylabel{S-FIELD2}
\[
\dfrac{\senv \vdash k_{2} \subtype k_{1} \;\;\;
       \senv \vdash t_{1} \subtype t_{2}}
      {\senv \vdash \Const \; k_{1}:t_{1} \subtype \Const \; k_{2}:t_{2}}
\]

\mylabel{S-FIELD3}
\[
\dfrac{\senv \vdash k_{2} \subtype k_{1} \;\;\;
       \senv \vdash t_{1} \subtype t_{2}}
      {\senv \vdash k_{1}:t_{1} \subtype \Const \; k_{2}:t_{2}}
\]

\mylabel{S-VARIABLE}
\[
\dfrac{x_{1} \subtype x_{2} \in \senv}
      {\senv \vdash x_{1} \subtype x_{2}}
\]

\mylabel{S-RECURSIVE1}
\[
\dfrac{\senv, x_{1} \subtype x_{2} \vdash t_{1} \subtype t_{2}}
      {\senv \vdash \mu x_{1}.t_{1} \subtype \mu x_{2}.t_{2}}
\]

\mylabel{S-RECURSIVE2}
\[
\dfrac{x \subtype x \not\in \senv \;\;\;
      \senv, x \subtype x \vdash t_{1} \subtype t_{2}}
      {\senv \vdash \mu x.t_{1} \subtype t_{2}}
\]

\mylabel{S-RECURSIVE3}
\[
\dfrac{x \subtype x \in \senv \;\;\;
       \senv \vdash x \subtype t_{2}}
      {\senv \vdash \mu s.t_{1} \subtype t_{2}}
\]

\mylabel{S-RECURSIVE4}
\[
\dfrac{x \subtype x \not\in \senv \;\;\;
       \senv, x \subtype x \vdash t_{1} \subtype t_{2}}
      {\senv \vdash t_{1} \subtype \mu x.t_{2}}
\]

\mylabel{S-RECURSIVE5}
\[
\dfrac{x \subtype x \in \senv \;\;\;
       \senv \vdash t_{1} \subtype x}
      {\senv \vdash t_{1} \subtype \mu x.t_{2}}
\]

\mylabel{S-VOID}
\[
\senv \vdash \Void \subtype \Void
\]

\mylabel{S-VARARG}
\[
\dfrac{\senv \vdash t_{1} \cup \Nil \subtype t_{2} \cup \Nil}
      {\senv \vdash t_{1}* \subtype t_{2}*}
\]

\mylabel{S-TUPLE1}
\[
\dfrac{\senv \vdash t_{1} \subtype t_{2} \;\;\;
       \senv \vdash s_{1} \subtype s_{2}}
      {\senv \vdash t_{1} \times s_{1} \subtype t_{2} \times s_{2}}
\]

\mylabel{S-TUPLE2}
\[
\dfrac{\senv \vdash t_{1} \cup \Nil \subtype t_{2} \;\;\;
       \senv \vdash t_{1}* \subtype s_{2}}
      {\senv \vdash t_{1}* \subtype t_{2} \times s_{2}}
\]

\mylabel{S-TUPLE3}
\[
\dfrac{\senv \vdash t_{1} \subtype t_{2} \cup \Nil \;\;\;
       \senv \vdash s_{1} \subtype t_{2}*}
      {\senv \vdash t_{1} \times s_{1} \subtype t_{2}*}
\]

\section{Consistent-Subtyping}

\noindent

\mylabel{C-ANY1}
\[
\senv \vdash t \lesssim \Any
\]

\mylabel{C-ANY2}
\[
\senv \vdash \Any \lesssim t
\]

\section{Abstract Syntax}

\begin{figure}[!ht]
\textbf{Abstract Syntax}\\
\dstart
$$
\begin{array}{rl}
s ::= & \;\; \mathbf{skip} \; | \;
s_{1} \; ; \; s_{2} \; | \;
\vec{l} = \vec{e}  \; | \;
\mathbf{while} \; e \; \mathbf{do} \; s \; | \;
\mathbf{if} \; e \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}\\
& | \; \mathbf{local} \; \vec{n{:}t} = \vec{e} \; \mathbf{in} \; s \; | \;
\mathbf{rec} \; n{:}t = f \; \mathbf{in} \; s \; | \;
\mathbf{return} \; \vec{e} \; | \;
a\\
e ::= & \;\; \mathbf{nil} \; | \;
\mathbf{false} \; | \;
\mathbf{true} \; | \;
{\it number} \; | \;
{\it string} \; | \;
{...} \; | \;
f \; | \;
\{ \; \vec{c} \; \} \\
& | \; e_{1} + e_{2} \; | \;
e_{1} \; {..} \; e_{2} \; | \;
e_{1} == e_{2} \; | \;
e_{1} < e_{2} \; | \;
e_{1} \; \mathbf{and} \; e_{2} \; | \;
e_{1} \; \mathbf{or} \; e_{2} \\
& | \; \mathbf{not} \; e \; | \;
- e \; | \;
\# \; e \; | \;
a \; | \;
l \; | \;
(e) \; | \;
{<}t{>} \; n\\
l ::= & \; n \; | \;
e_{1}[e_{2}]\\
a ::= & \; e_{1}(\vec{e_{2}}) \; | \;
e_{1}{:}n(\vec{e_{2}})\\
f ::= & \; \mathbf{fun} \; (){:}r \; s \; | \;
\mathbf{fun} \; ({...}{:}t){:}r \; s \; | \;
\mathbf{fun} \; (\vec{n{:}t}){:}r \; s \; | \;
\mathbf{fun} \; (\vec{n{:}t},{...}{:}t){:}r \; s\\
c ::= & \; [e_{1}] = e_{2}\\
n ::= & \; {\it name}\\
\end{array}
$$
\dend
\caption{Typed Lua abstract syntax}
\label{fig:syntax}
\end{figure}

\section{Typing rules}

\noindent

\mylabel{T-SKIP}
\[
\env_{1} \vdash \mathbf{skip}:\env_{1}
\]

\mylabel{T-SEQ}
\[
\dfrac{\env_{1} \vdash s_{1}:\env_{2} \;\;\;
       \env_{2} \vdash s_{2}:\env_{3}}
      {\env_{1} \vdash s_{1} \; ; \; s_{2}:\env_{3}}
\]

\mylabel{T-ASSIGNMENT}
\[
\dfrac{\env_{1} \vdash \vec{e}:r_{1}, \env_{2} \;\;\;
       \env_{2} \vdash \vec{l}:r_{2}, \env_{3} \;\;\;
       r_{1} \lesssim r_{2}}
      {\env_{1} \vdash \vec{l} = \vec{e}:\env_{3}}
\]

\mylabel{T-WHILE}
\[
\dfrac{\env_{1} \vdash e:t, \env_{2} \;\;\;
       closeall(\env_{2}) \vdash s:\env_{3}}
      {\env_{1} \vdash \mathbf{while} \; e \; \mathbf{do} \; s:closeset(\env_{2}, fav())}
\]

\mylabel{T-IF}
\[
\dfrac{\env_{1} \vdash e:t, \env_{2} \;\;\;
       closeall(\env_{2}) \vdash s_{1}:\env_{3} \;\;\;
       closeall(closeset(\env_{2}, fav())) \vdash s_{2}:\env_{4}}
      {\env_{1} \vdash \mathbf{if} \; e \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}:closeset(\env_{2}, fav())}
\]

\mylabel{T-LOCAL}
\[
\dfrac{\env_{1} \vdash \vec{e}:r_{1}, \env_{2} \;\;\;
       r_{1} \lesssim \vec{t} \;\;\;
       \env_{2}[\vec{n} \mapsto \vec{t}] \vdash s:\env_{3}}
      {\env_{1} \vdash \mathbf{local} \; \vec{n{:}t} = \vec{e} \; \mathbf{in} \; s:\env_{3} - \{\vec{n} \mapsto \vec{t}\}}
\]

\mylabel{T-LOCALREC}
\[
\dfrac{\env_{1}[n \mapsto t] \vdash f:t_{1}, \env_{2} \;\;\;
       t_{1} \lesssim t \;\;\;
       \env_{2}[n \mapsto t] \vdash s:\env_{3}}
      {\env_{1} \vdash \mathbf{rec} \; n{:}t = f \; \mathbf{in} \; s:\env_{3} - \{n \mapsto t\}}
\]

\mylabel{T-RETURN}
\[
\dfrac{\env_{1} \vdash \vec{e}:r_{1}, \env_{2} \;\;\;
       \env_{2}(\ret) = r_{2} \;\;\;
       r_{1} \lesssim r_{2}}
      {\env_{1} \vdash \mathbf{return} \; \vec{e}:\env_{2}}
\]

\mylabel{T-EXPLIST1}
\[
\dfrac{|\vec{e}| = 0}
      {\env \vdash \vec{e}:\Nil{*}}
\]

\mylabel{T-EXPLIST2}
\[
\dfrac{|\vec{e}| > 0 \;\;\;
       \env \vdash \vec{e}:t_{1} \times ... \times t_{n}}
      {\env \vdash \vec{e}:t_{1} \times ... \times t_{n} \times \Nil{*}}
\]

\mylabel{T-EXPLIST3}
\[
\dfrac{|\vec{e}| > 0 \;\;\;
       \env \vdash \vec{e}:t_{1} \times ... \times t_{n}{*}}
      {\env \vdash \vec{e}:t_{1} \times ... \times t_{n}{*}}
\]

\mylabel{T-NIL}
\[
\env_{1} \vdash \mathbf{nil}:\Nil, \env_{1}
\]

\mylabel{T-FALSE}
\[
\env_{1} \vdash \mathbf{false}:\False, \env_{1}
\]

\mylabel{T-TRUE}
\[
\env_{1} \vdash \mathbf{true}:\True, \env_{1}
\]

\mylabel{T-NUM}
\[
\env_{1} \vdash {\it number}:{\it number}, \env_{1}
\]

\mylabel{T-STR}
\[
\env_{1} \vdash {\it string}:{\it string}, \env_{1}
\]

\mylabel{T-DOTS}
\[
\dfrac{\env_{1}({...}) = t}
      {\env_{1} \vdash {...}:t{*}, \env_{1}}
\]

\mylabel{T-FUNCTION1}
\[
\dfrac{closeall(\env_{1}[\ret \mapsto r]) \vdash s:\env_{2}}
      {\env_{1} \vdash \mathbf{fun} \; (){:}r \; s:\Void \rightarrow r, closeset(\env_{1}, fav())}
\]

\mylabel{T-FUNCTION2}
\[
\dfrac{closeall(\env_{1}[{...} \mapsto t, \ret \mapsto r]) \vdash s:\env_{2}}
      {\env_{1} \vdash \mathbf{fun} \; ({...}{:}t){:}r \; s:t{*} \rightarrow r, closeset(\env_{1}, fav())}
\]

\mylabel{T-FUNCTION3}
\[
\dfrac{closeall(\env_{1}[\vec{n} \mapsto \vec{t}, \ret \mapsto r]) \vdash s:\env_{2}}
      {\env_{1} \vdash \mathbf{fun} \; (\vec{n{:}t}){:}r \; s:\vec{t} \rightarrow r, closeset(\env_{1}, fav())}
\]

\mylabel{T-FUNCTION4}
\[
\dfrac{closeall(\env_{1}[\vec{n} \mapsto \vec{t}, {...} \mapsto t, \ret \mapsto r]) \vdash s:\env_{2}}
      {\env_{1} \vdash \mathbf{fun} \; (\vec{n{:}t},{...}{:}t){:}r \; s: \vec{t} \times t{*} \rightarrow r, closeset(\env_{1}, fav())}
\]

\mylabel{T-FIELD1}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3} \;\;\;
       t_{1} \subtype \Boolean}
      {\env_{1} \vdash [e_{1}] = e_{2}:t_{1}:t_{2}, \env_{3}}
\]

\mylabel{T-FIELD2}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3} \;\;\;
       t_{1} \subtype \Number}
      {\env_{1} \vdash [e_{1}] = e_{2}:t_{1}:t_{2}, \env_{3}}
\]

\mylabel{T-FIELD3}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3} \;\;\;
       t_{1} \subtype \String}
      {\env_{1} \vdash [e_{1}] = e_{2}:t_{1}:t_{2}, \env_{3}}
\]

\mylabel{T-FIELD4}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3} \;\;\;
       t_{1} \lesssim \Any \;\;\;
       t_{1} \not\subtype \Nil}
      {\env_{1} \vdash [e_{1}] = e_{2}:\Any:t_{2}, \env_{3}}
\]

\mylabel{T-CONSTRUCTOR}
\[
\dfrac{\env_{1} \vdash \vec{c}:\{ v_{i}, ..., v_{n} \}_{u}, \env_{2}}
      {\env_{1} \vdash \{ \; \vec{c} \; \}:\{ v_{i}, ..., v_{n} \}_{u}, \env_{2}}
\]

\mylabel{T-ARITH1}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3} \;\;\;
       t_{1} \subtype \Number \;\;\;
       t_{2} \subtype \Number}
      {\env_{1} \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH2}
\[
\dfrac{\env_{1} \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t, \env_{3}}
      {\env_{1} \vdash e_{1} + e_{2}:\Any, \env_{3}}
\]

\mylabel{T-ARITH3}
\[
\dfrac{\env_{1} \vdash e_{1}:t, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:\Any, \env_{3}}
      {\env_{1} \vdash e_{1} + e_{2}:\Any, \env_{3}}
\]

\mylabel{T-CONCAT1}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3} \;\;\;
       t_{1} \subtype \String \;\;\;
       t_{2} \subtype \String}
      {\env_{1} \vdash e_{1} \; {..} \; e_{2}:\String, \env_{3}}
\]

\mylabel{T-CONCAT2}
\[
\dfrac{\env_{1} \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t, \env_{3}}
      {\env_{1} \vdash e_{1} \; {..} \; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-CONCAT3}
\[
\dfrac{\env_{1} \vdash e_{1}:t, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:\Any, \env_{3}}
      {\env_{1} \vdash e_{1} \; {..} \; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-EQUAL}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3}}
      {\env_{1} \vdash e_{1} == e_{2}:\Boolean, \env_{3}}
\]

\mylabel{T-ORDER1}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3} \;\;\;
       t_{1} \subtype \Number \;\;\;
       t_{2} \subtype \Number}
      {\env \vdash e_{1} < e_{2}:\Boolean, \env_{3}}
\]

\mylabel{T-ORDER2}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3} \;\;\;
       t_{1} \subtype \String \;\;\;
       t_{2} \subtype \String}
      {\env_{1} \vdash e_{1} < e_{2}:\Boolean}
\]

\mylabel{T-ORDER3}
\[
\dfrac{\env_{1} \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t, \env_{3}}
      {\env_{1} \vdash e_{1} < e_{2}:\Any, \env_{3}}
\]

\mylabel{T-ORDER4}
\[
\dfrac{\env_{1} \vdash e_{1}:t, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:\Any, \env_{3}}
      {\env_{1} \vdash e_{1} < e_{2}:\Any, \env_{3}}
\]

\mylabel{T-AND1}
\[
\dfrac{\env_{1} \vdash e_{1}:\Nil, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{and} \; e_{2}:\Nil, \env_{3}}
\]

\mylabel{T-AND2}
\[
\dfrac{\env_{1} \vdash e_{1}:\False, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{and} \; e_{2}:\False, \env_{3}}
\]

\mylabel{T-AND3}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1} \cup \Nil, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{and} \; e_{2}:\Nil \cup t_{2}, \env_{3}}
\]

\mylabel{T-AND4}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1} \cup \False, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{and} \; e_{2}:\False \cup t_{2}, \env_{3}}
\]

\mylabel{T-AND5}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{and} \; e_{2}:t_{1} \cup t_{2}, \env_{3}}
\]

\mylabel{T-OR1}
\[
\dfrac{\env_{1} \vdash e_{1}:\Nil, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{or} \; e_{2}:t, \env_{3}}
\]

\mylabel{T-OR2}
\[
\dfrac{\env_{1} \vdash e_{1}:\False, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{or} \; e_{2}:t, \env_{3}}
\]

\mylabel{T-OR3}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1} \cup \Nil, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{or} \; e_{2}:t_{1} \cup t_{2}, \env_{3}}
\]

\mylabel{T-OR4}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1} \cup \False, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{or} \; e_{2}:t_{1} \cup t_{2}, \env_{3}}
\]

\mylabel{T-OR5}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3}}
      {\env_{1} \vdash e_{1} \; \mathbf{or} \; e_{2}:t_{1} \cup t_{2}, \env_{3}}
\]

\mylabel{T-NOT}
\[
\dfrac{\env_{1} \vdash e:t, \env_{2}}
      {\env_{1} \vdash \mathbf{not} \; e:\Boolean, \env_{2}}
\]

\mylabel{T-MINUS1}
\[
\dfrac{\env_{1} \vdash e:t, \env_{2} \;\;\;
       t \subtype \Number}
      {\env_{1} \vdash - e:\Number, \env_{2}}
\]

\mylabel{T-MINUS2}
\[
\dfrac{\env_{1} \vdash e:\Any, \env_{2}}
      {\env_{1} \vdash - e:\Any, \env_{2}}
\]

\mylabel{T-LEN1}
\[
\dfrac{\env_{1} \vdash e:t, \env_{2} \;\;\;
       t \subtype \String}
      {\env_{1} \vdash \# \; e:\Number, \env_{2}}
\]

\mylabel{T-LEN2}
\[
\dfrac{\env_{1} \vdash e:t, \env_{2} \;\;\;
       t \subtype \{\}_{c}}
      {\env_{1} \vdash \# \; e:\Number, \env_{2}}
\]

\mylabel{T-LEN3}
\[
\dfrac{\env_{1} \vdash e:\Any, \env_{2}}
      {\env_{1} \vdash \# \; e:\Any, \env_{2}}
\]

\mylabel{T-APPLY1}
\[
\dfrac{\env_{1} \vdash e_{1}:p_{1} \rightarrow r, \env_{2} \;\;\;
       \env_{2} \vdash \vec{e_{2}}:p_{2}, \env_{3} \;\;\;
       p_{2} \lesssim p_{1}}
      {\env_{1} \vdash e_{1}(\vec{e_{2}}):r, \env_{3}}
\]

\mylabel{T-APPLY2}
\[
\dfrac{\env_{1} \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2} \vdash \vec{e_{2}}:p, \env_{3}}
      {\env_{1} \vdash e_{1}(\vec{e_{2}}):\Any{*}, \env_{3}}
\]

\mylabel{T-INVOKE1}
\[
\dfrac{\env_{1} \vdash e_{1}[n]:p_{1} \rightarrow r, \env_{2} \;\;\;
       \env_{2} \vdash \vec{e_{2}}:p_{2}, \env_{3} \;\;\;
       p_{2} \lesssim p_{1}}
      {\env_{1} \vdash e_{1}{:}n(\vec{e_{2}}):r, \env_{3}}
\]

\mylabel{T-INVOKE2}
\[
\dfrac{\env_{1} \vdash e_{1}[n]:\Any, \env_{2} \;\;\;
       \env_{2} \vdash \vec{e_{2}}:p, \env_{3}}
      {\env_{1} \vdash e_{1}{:}n(\vec{e_{2}}):\Any{*}, \env_{3}}
\]

\mylabel{T-ID}
\[
\dfrac{\env_{1}(n) = t}
      {\env_{1} \vdash n:t, \env_{1}}
\]

\mylabel{T-INDEX1}
\[
\dfrac{\env_{1} \vdash e_{1}:\{k_{1}{:}t_{1}, ..., k_{n}{:}t_{n}\}, \env_{1} \;\;\;
       \env_{2} \vdash e_{2}:t, \env_{3} \;\;\;
       \exists i \in 1{..}n \; t \lesssim k_{i}}
      {\env_{1} \vdash e_{1}[e_{2}]:t_{i}, \env_{3}}
\]

\mylabel{T-INDEX2}
\[
\dfrac{\env_{1} \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t, \env_{3}}
      {\env_{1} \vdash e_{1}[e_{2}]:\Any, \env_{3}}
\]

\mylabel{T-PAREN1}
\[
\dfrac{\env_{1} \vdash e:t, \env_{2}}
      {\env_{1} \vdash (e):t, \env_{2}}
\]

\mylabel{T-PAREN2}
\[
\dfrac{\env_{1} \vdash e:s, \env_{2}}
      {\env_{1} \vdash (e):first(s), \env_{2}}
\]

\mylabel{T-CAST}
\[
\dfrac{t \subtype \env_{1}(n)}
      {\env_{1} \vdash {<}t{>} \; n:t, \env_{1}[n \mapsto t]}
\]

\mylabel{T-SELF}
\[
\dfrac{\env_{1} \vdash e:\Self, \env_{2} \;\;\;
       \env_{2}(\Self) = t}
      {\env_{1} \vdash e:t, \env_{2}}
\]

\mylabel{T-RECURSIVE}
\[
\dfrac{\env_{1} \vdash e:\mu x.t, \env_{2}}
      {\env_{1} \vdash e:t[x \mapsto \mu x.t], \env_{2}}
\]

\mylabel{T-TERNARY}
\[
\dfrac{\env_{1} \vdash e_{1}:t_{1}, \env_{2} \;\;\;
       \env_{2} \vdash e_{2}:t_{2}, \env_{3} \;\;\;
       \env_{3} \vdash e_{3}:t_{2}, \env_{4}}
      {\env_{1} \vdash e_{1} \; \mathbf{and} \; e_{2} \; \mathbf{or} \; e_{3}:t_{2}, \env_{4}}
\]


\end{document}
