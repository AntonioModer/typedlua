\documentclass[12pt]{article}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amssymb}

\newcommand{\Top}{\mathbf{value}}
\newcommand{\Any}{\mathbf{any}}
\newcommand{\Nil}{\mathbf{nil}}
\newcommand{\False}{\mathbf{false}}
\newcommand{\True}{\mathbf{true}}
\newcommand{\Boolean}{\mathbf{boolean}}
\newcommand{\Number}{\mathbf{number}}
\newcommand{\String}{\mathbf{string}}
\newcommand{\Void}{\mathbf{void}}

\newcommand{\kw}[1]{\mathbf{\texttt{#1}}}
\newcommand{\mylabel}[1]{\; (\textsc{#1})}
\newcommand{\subtype}{<:}
\newcommand{\env}{\Gamma}
\newcommand{\ret}{\string_RET}

\def\dstart{\hbox to \hsize{\vrule depth 4pt\hrulefill\vrule depth 4pt}}
\def\dend{\hbox to \hsize{\vrule height 4pt\hrulefill\vrule height 4pt}}

\title{Typed Lua Type System}

\author{AndrÃ© Murbach Maidl}

\begin{document}

\maketitle

\section{Type Language}

\textbf{Type Language}\\
\dstart
$$
\begin{array}{rlr}
\multicolumn{3}{c}{\textbf{First-class types}}\\
T ::= & \;\; L & \textit{literal types}\\
& | \; B & \textit{base types}\\
& | \; \Top & \textit{top type}\\
& | \; \Any & \textit{dynamic type}\\
& | \; T \cup T & \textit{disjoint union types}\\
& | \; S \rightarrow S & \textit{function types}\\
%& | \; \{T:T, ..., T:T\} & \textit{table types}\\
%& | \; X & \textit{type variables}\\
%& | \; \mu X.T & \textit{recursive types}\\
L ::= & \False \; | \; \True \; | \; {<}{\it number}{>} \; | \; {<}{\it string}{>} & \\
B ::= & \Nil \; | \; \Boolean \; | \; \Number \; | \; \String & \\
\multicolumn{3}{c}{}\\
\multicolumn{3}{c}{\textbf{Second-class types}}\\
S ::= & V & \\
%S ::= & V \; | \; V \cup S & \\
V ::= & \;\; T & \\
& | \; T* & \textit{vararg types}\\
& | \; T \times V & \textit{tuple types}
\end{array}
$$
\dend

\section{Subtyping}

\subsection{Literal types}

\[
L \subtype L
\mylabel{S-LITERAL}
\]

\[
\False \subtype \Boolean
\mylabel{S-FALSE}
\]

\[
\True \subtype \Boolean
\mylabel{S-TRUE}
\]

\[
{<}{\it number}{>} \subtype \Number
\mylabel{S-NUMBER}
\]

\[
{<}{\it string}{>} \subtype \String
\mylabel{S-STRING}
\]

\subsection{Base types}

\[
B \subtype B
\mylabel{S-BASE}
\]

\subsection{Top type}

\[
T \subtype \Top
\mylabel{S-TOP}
\]

\subsection{Dynamic type}

\[
\Any \subtype \Any
\mylabel{S-ANY}
\]

\subsection{Union types}

\[
\frac{T_{1} \subtype T \;\;\; T_{2} \subtype T}
     {T_{1} \cup T_{2} \subtype T}
\mylabel{S-UNION1}
\]

\[
\frac{T \subtype T_{1}}
     {T \subtype T_{1} \cup T_{2}}
\mylabel{S-UNION2}
\]

\[
\frac{T \subtype T_{2}}
     {T \subtype T_{1} \cup T_{2}}
\mylabel{S-UNION3}
\]

\subsection{Function types}

\[
\frac{S_{3} \subtype S_{1} \;\;\; S_{2} \subtype S_{4}}
     {S_{1} \rightarrow S_{2} \subtype S_{3} \rightarrow S_{4}}
\mylabel{S-FUNCTION}
\]

\subsection{Vararg types}

\[
\frac{T_{1} \cup \Nil \subtype T_{2} \cup \Nil}
     {T_{1}* \subtype T_{2}*}
\mylabel{S-VARARG}
\]

\subsection{Tuple types}

\[
\frac{T_{1} \subtype T_{2} \;\;\; V_{1} \subtype V_{2}}
     {T_{1} \times V_{1} \subtype T_{2} \times V_{2}}
\mylabel{S-TUPLE1}
\]

\[
\frac{T_{1} \cup \Nil \subtype T_{2} \;\;\; T_{1}* \subtype V_{2}}
     {T_{1}* \subtype T_{2} \times V_{2}}
\mylabel{S-TUPLE2}
\]

\[
\frac{T_{1} \subtype T_{2} \cup \Nil \;\;\; V_{1} \subtype T_{2}*}
     {T_{1} \times V_{1} \subtype T_{2}*}
\mylabel{S-TUPLE3}
\]

\section{Consistent-Subtyping}

\subsection{Literal types}

\[
L \lesssim L
\mylabel{C-LITERAL}
\]

\[
\False \lesssim \Boolean
\mylabel{C-FALSE}
\]

\[
\True \lesssim \Boolean
\mylabel{C-TRUE}
\]

\[
{<}{\it number}{>} \lesssim \Number
\mylabel{C-NUMBER}
\]

\[
{<}{\it string}{>} \lesssim \String
\mylabel{C-STRING}
\]

\subsection{Base types}

\[
B \lesssim B
\mylabel{C-BASE}
\]

\subsection{Top type}

\[
T \lesssim \Top
\mylabel{C-TOP}
\]

\subsection{Dynamic type}

\[
T \lesssim \Any
\mylabel{C-ANY1}
\]

\[
\Any \lesssim T
\mylabel{C-ANY2}
\]

\subsection{Union types}

\[
\frac{T_{1} \lesssim T \;\;\; T_{2} \lesssim T}
     {T_{1} \cup T_{2} \lesssim T}
\mylabel{C-UNION1}
\]

\[
\frac{T \lesssim T_{1}}
     {T \lesssim T_{1} \cup T_{2}}
\mylabel{C-UNION2}
\]

\[
\frac{T \lesssim T_{2}}
     {T \lesssim T_{1} \cup T_{2}}
\mylabel{C-UNION3}
\]

\subsection{Function types}

\[
\frac{S_{3} \lesssim S_{1} \;\;\; S_{2} \lesssim S_{4}}
     {S_{1} \rightarrow S_{2} \lesssim S_{3} \rightarrow S_{4}}
\mylabel{C-FUNCTION}
\]

\subsection{Vararg types}

\[
\frac{T_{1} \cup \Nil \lesssim T_{2} \cup \Nil}
     {T_{1}* \lesssim T_{2}*}
\mylabel{C-VARARG}
\]

\subsection{Tuple types}

\[
\frac{T_{1} \lesssim T_{2} \;\;\; V_{1} \lesssim V_{2}}
     {T_{1} \times V_{1} \lesssim T_{2} \times V_{2}}
\mylabel{C-TUPLE1}
\]

\[
\frac{T_{1} \cup \Nil \lesssim T_{2} \;\;\; T_{1}* \lesssim V_{2}}
     {T_{1}* \lesssim T_{2} \times V_{2}}
\mylabel{C-TUPLE2}
\]

\[
\frac{T_{1} \lesssim T_{2} \cup \Nil \;\;\; V_{1} \lesssim T_{2}*}
     {T_{1} \times V_{1} \lesssim T_{2}*}
\mylabel{C-TUPLE3}
\]

\section{Typing Rules}

\subsection{Abstract Syntax}

\textbf{Abstract Syntax}\\
\dstart
$$
\begin{array}{rl}
s ::= & \;\; \kw{skip} \; | \;
s_{1} \; ; \; s_{2} \; | \;
\vec{l} = \vec{e}  \; | \;
\kw{while} \; e \; \kw{do} \; s \; | \;
\kw{repeat} \; s \; \kw{until} \; e\\
& | \; \kw{if} \; e \; \kw{then} \; s_{1} \; \kw{else} \; s_{2} \; | \;
\kw{for} \; i = e_{1},e_{2},e_{3} \; \kw{do} \; s \; | \;
\kw{for} \; \vec{i}{:}\vec{t} \; \kw{in} \; \vec{e} \; \kw{do} \; s\\
& | \; \kw{local} \; \vec{i}{:}\vec{t} = \vec{e} \; \kw{in} \; s \; | \;
\kw{rec} \; i{:}t = f \; \kw{in} \; s \; | \;
\kw{goto} \; i \; | \;
{::} \; i \; {::} \; | \;
\kw{return} \; \vec{e}\\
& | \; \kw{break} \; | \;
e_{1}(\vec{e_{2}})\\
e ::= & \;\; \kw{nil} \; | \;
\kw{false} \; | \;
\kw{true} \; | \;
{<}{\it number}{>} \; | \;
{<}{\it string}{>} \; | \;
{...} \; | \;
f \; | \;
\{ \; \vec{c} \; \} \\
& | \; e_{1} + e_{2} \; | \;
e_{1} \; {..} \; e_{2} \; | \;
e_{1} == e_{2} \; | \;
e_{1} < e_{2} \; | \;
e_{1} \; \kw{and} \; e_{2} \; | \;
e_{1} \; \kw{or} \; e_{2} \\
& | \; \kw{not} \; e \; | \;
- e \; | \;
\# \; e \; | \;
e_{1}(\vec{e_{2}}) \; | \;
l \\
l ::= & \; i \; | \;
e_{1}[e_{2}]\\
f ::= & \; \kw{fun} \; (){:}t \; b \; | \;
\kw{fun} \; ({...}{:}t_{1}){:}t_{2} \; b \; | \;
\kw{fun} \; (\vec{i}{:}\vec{t_{1}}){:}t_{2} \; b \; | \;
\kw{fun} \; (\vec{i}{:}\vec{t_{1}},{...}{:}t_{2}){:}t_{3} \; b\\
c ::= & \; e_{1} = e_{2} \; | \;
e\\
b ::= & \; s \; ; \; \kw{return} \; \vec{e}
\end{array}
$$
\dend

\subsection{Typing rules}

\subsection{Statements}

\[
\env \vdash \kw{skip}
\mylabel{T-SKIP}
\]

\[
\frac{\env \vdash s_{1} \;\;\;
      \env \vdash s_{2}}
     {\env \vdash s_{1} \;;\; s_{2}}
\mylabel{T-SEQ}
\]

\[
\frac{\env \vdash \vec{e}:S_{1} \;\;\;
      \env \vdash \vec{l}:S_{2} \;\;\;
      \env \vdash S_{1} \lesssim S_{2}}
     {\env \vdash \vec{l} = \vec{e}}
\mylabel{T-ASSIGNMENT}
\]

\[
\frac{\env \vdash e:T \;\;\;
      \env \vdash s}
     {\env \vdash \kw{while} \; e \; \kw{do} \; s}
\mylabel{T-WHILE}
\]

\[
\frac{\env \vdash s \;\;\;
      \env \vdash e:T}
     {\env \vdash \kw{repeat} \; s \; \kw{until} \; e}
\mylabel{T-REPEAT}
\]

\[
\frac{\env \vdash e:T \;\;\;
      \env \vdash s_{1} \;\;\;
      \env \vdash s_{2}}
     {\env \vdash \kw{if} \; e \; \kw{then} \; s_{1} \; \kw{else} \; s_{2}}
\mylabel{T-IF-ELSE}
\]

\[
\frac{\begin{aligned}
      & \env \vdash e_{1}:T_{1} \;\;\;
        \env \vdash e_{2}:T_{2} \;\;\;
        \env \vdash e_{3}:T_{3} & \\
      & T_{1} \lesssim \Number \;\;\;
        T_{2} \lesssim \Number \;\;\;
        T_{3} \lesssim \Number & \\
      & \env, i:\Number \vdash s &
      \end{aligned}}
     {\env \vdash \kw{for} \; i = e_{1},e_{2},e_{3} \; \kw{do} \; s}
\mylabel{T-FORNUM}
\]

\[
\frac{\env \vdash \vec{e}:S_{1} \;\;\;
      \env \vdash \vec{i}{:}\vec{t}:S_{2} \;\;\;
      S_{1} \lesssim S_{2} \;\;\;
      \env, \vec{i}{:}\vec{t}}
     {\env \vdash \kw{for} \; \vec{i}{:}\vec{t} \; \kw{in} \; \vec{e} \; \kw{do} \; s}
\mylabel{T-FORIN}
\]

\[
\frac{\env \vdash \vec{e}:S \;\;\;
      S \lesssim T_{1} \times {...} \times T_{n} \times \Top{*} \;\;\;
      \env, \vec{i}:\vec{t} \vdash s}
     {\env \vdash \kw{local} \; \vec{i}{:}\vec{t} = \vec{e} \; \kw{in} \; s}
\mylabel{T-LOCAL}
\]

\[
\frac{\env, i:S_{1} \rightarrow S_{2}, \ret:S_{2} \vdash f:S_{1} \rightarrow S_{2} \;\;\;
      \env, i:S_{1} \rightarrow S_{2}, \ret:S_{2} \vdash s}
     {\env \vdash \kw{rec} \; i{:}t = f \; \kw{in} \; s}
\mylabel{T-LOCALREC}
\]

\[
\env \vdash \kw{goto} \; i
\mylabel{T-GOTO}
\]

\[
\env \vdash {::} \; i \; {::}
\mylabel{T-LABEL}
\]

\[
\frac{\env \vdash \vec{e}:S_{1} \;\;\;
      \env(\ret) = S_{2} \;\;\;
      S_{1} \lesssim S_{2}}
     {\env \vdash \kw{return} \; \vec{e}}
\mylabel{T-RETURN}
\]

\[
\env \vdash \kw{break}
\mylabel{T-BREAK}
\]

\[
\frac{\env \vdash \vec{e_{2}}:S_{1} \;\;\;
      \env \vdash e_{1}:S_{2} \rightarrow S_{3} \;\;\;
      S_{1} \lesssim S_{2}}
     {\env \vdash e_{1}(\vec{e_{2}})}
\mylabel{T-STMCALL1}
\]

\[
\frac{\env \vdash \vec{e_{2}}:S \;\;\;
      \env \vdash e_{1}:\Any}
     {\env \vdash e_{1}(\vec{e_{2}})}
\mylabel{T-STMCALL2}
\]

\subsubsection{Expressions}

\[
\env \vdash \kw{nil} : \Nil
\mylabel{T-NIL}
\]

\[
\env \vdash \kw{false} : \False
\mylabel{T-FALSE}
\]

\[
\env \vdash \kw{true} : \True
\mylabel{T-TRUE}
\]

\[
\env \vdash {<}{\it number}{>} : {<}{\it number}{>}
\mylabel{T-NUMBER}
\]

\[
\env \vdash {<}{\it string}{>} : {<}{\it string}{>}
\mylabel{T-STRING}
\]

\[
\frac{\env({...}) = T}
     {\env \vdash {...} : T{*}}
\mylabel{T-DOTS}
\]

\[
\frac{\env, \ret:T_{1} \times ... \times T_{n}* \vdash b}
     {\env \vdash \kw{fun} \; (){:}t \; b :
      \Top{*} \rightarrow T_{1} \times ... \times T_{n}*}
\mylabel{T-FUNCTION1}
\]

\[
\frac{\env, \ret:T_{1} \times ... \times T_{n} \times \Nil{*} \vdash b}
     {\env \vdash \kw{fun} \; (){:}t \; b :
      \Top{*} \rightarrow T_{1} \times ... \times T_{n} \times \Nil{*}}
\mylabel{T-FUNCTION2}
\]

\[
\frac{\env, {...}:T_{1}, \ret:T_{2} \times ... \times T_{n}* \vdash b}
     {\env \vdash \kw{fun} \; ({...}{:}t_{1}){:}t_{2} \; b :
      T_{1}{*} \rightarrow T_{2} \times ... \times T_{n}*}
\mylabel{T-FUNCTION3}
\]

\[
\frac{\env, {...}:T_{1}, \ret:T_{2} \times ... \times T_{n} \times \Nil{*} \vdash b}
     {\env \vdash \kw{fun} \; ({...}{:}t_{1}){:}t_{2} \; b :
      T_{1}{*} \rightarrow T_{2} \times ... \times T_{n} \times \Nil{*}}
\mylabel{T-FUNCTION4}
\]

\[
\frac{\env, \vec{i}:\vec{t_{1}},
      \ret:T_{2} \times ... \times T_{n}* \vdash b}
     {\env \vdash \kw{fun} \; (\vec{i}{:}\vec{t_{1}}){:}t_{2} \; b :
      S \times \Top{*} \rightarrow T_{2} \times ... \times T_{n}*}
\mylabel{T-FUNCTION5}
\]

\[
\frac{\env, \vec{i}:\vec{t_{1}},
      \ret:T_{2} \times ... \times T_{n} \times \Nil{*} \vdash b}
     {\env \vdash \kw{fun} \; (\vec{i}{:}\vec{t_{1}}){:}t_{2} \; b :
      S \times \Top{*} \rightarrow T_{2} \times ... \times T_{n} \times \Nil{*}}
\mylabel{T-FUNCTION6}
\]

\[
\frac{\env, \vec{i}:\vec{t_{1}}, {...}:T_{2},
      \ret:T_{3} \times ... \times T_{n}* \vdash b}
     {\env \vdash \kw{fun} \; (\vec{i}{:}\vec{t_{1}},{...}{:}t_{2}){:}t_{3} \; b :
      S \times T_{2}* \rightarrow T_{3} \times ... \times T_{n}*}
\mylabel{T-FUNCTION7}
\]

\[
\frac{\env, \vec{i}:\vec{t_{1}}, {...}:T_{2},
      \ret:T_{3} \times ... \times T_{n} \times \Nil{*} \vdash b}
     {\env \vdash \kw{fun} \; (\vec{i}{:}\vec{t_{1}},{...}{:}t_{2}){:}t_{3} \; b :
      S \times T_{2}* \rightarrow T_{3} \times ... \times T_{n} \times \Nil{*}}
\mylabel{T-FUNCTION8}
\]

\[
\env \vdash \{ \; \vec{c} \; \} : \Any
\mylabel{T-TABLE}
\]

\[
\frac{\env \vdash e_{1}:T_{1} \;\;\;
      \env \vdash e_{2}:T_{2} \;\;\;
      T_{1} \subtype \Number \;\;\;
      T_{2} \subtype \Number}
     {\env \vdash e_{1} + e_{2} : \Number}
\mylabel{T-ARITH1}
\]

\[
\frac{\env \vdash e_{1}:\Any \;\;\;
      \env \vdash e_{2}:T}
     {\env \vdash e_{1} + e_{2} : \Any}
\mylabel{T-ARITH2}
\]

\[
\frac{\env \vdash e_{1}:T \;\;\;
      \env \vdash e_{2}:\Any}
     {\env \vdash e_{1} + e_{2} : \Any}
\mylabel{T-ARITH3}
\]

\[
\frac{\env \vdash e_{1}:T_{1} \;\;\;
      \env \vdash e_{2}:T_{2} \;\;\;
      T_{1} \subtype \String \;\;\;
      T_{2} \subtype \String}
     {\env \vdash e_{1} \; {..} \; e_{2} : \String}
\mylabel{T-CONCAT1}
\]

\[
\frac{\env \vdash e_{1}:\Any \;\;\;
      \env \vdash e_{2}:T}
     {\env \vdash e_{1} \; {..} \; e_{2} : \Any}
\mylabel{T-CONCAT2}
\]

\[
\frac{\env \vdash e_{1}:T \;\;\;
      \env \vdash e_{2}:\Any}
     {\env \vdash e_{1} \; {..} \; e_{2} : \Any}
\mylabel{T-CONCAT3}
\]

\[
\frac{\env \vdash e_{1}:T_{1} \;\;\;
      \env \vdash e_{2}:T_{2}}
     {\env \vdash e_{1} == e_{2} : \Boolean}
\mylabel{T-EQUAL}
\]

\[
\frac{\env \vdash e_{1}:T_{1} \;\;\;
      \env \vdash e_{2}:T_{2} \;\;\;
      T_{1} \subtype \Number \;\;\;
      T_{2} \subtype \Number}
     {\env \vdash e_{1} < e_{2} : \Boolean}
\mylabel{T-ORDER1}
\]

\[
\frac{\env \vdash e_{1}:T_{1} \;\;\;
      \env \vdash e_{2}:T_{2} \;\;\;
      T_{1} \subtype \String \;\;\;
      T_{2} \subtype \String}
     {\env \vdash e_{1} < e_{2} : \Boolean}
\mylabel{T-ORDER2}
\]

\[
\frac{\env \vdash e_{1}:\Any \;\;\;
      \env \vdash e_{2}:T}
     {\env \vdash e_{1} < e_{2} : \Any}
\mylabel{T-ORDER3}
\]

\[
\frac{\env \vdash e_{1}:T \;\;\;
      \env \vdash e_{2}:\Any}
     {\env \vdash e_{1} < e_{2} : \Any}
\mylabel{T-ORDER4}
\]

\[
\frac{\env \vdash e_{1}:\Nil \;\;\;
      \env \vdash e_{2}:T}
     {\env \vdash e_{1} \; \kw{and} \; e_{2} : \Nil}
\mylabel{T-AND1}
\]

\[
\frac{\env \vdash e_{1}:\False \;\;\;
      \env \vdash e_{2}:T}
     {\env \vdash e_{1} \; \kw{and} \; e_{2} : \False}
\mylabel{T-AND2}
\]

\[
\frac{\env \vdash e_{1}:T_{1} \;\;\;
      \env \vdash e_{2}:T_{2}}
     {\env \vdash e_{1} \; \kw{and} \; e_{2} : T_{1} \cup T_{2}}
\mylabel{T-AND3}
\]

\[
\frac{\env \vdash e_{1}:\Nil \;\;\;
      \env \vdash e_{2}:T}
     {\env \vdash e_{1} \; \kw{or} \; e_{2} : T}
\mylabel{T-OR1}
\]

\[
\frac{\env \vdash e_{1}:\False \;\;\;
      \env \vdash e_{2}:T}
     {\env \vdash e_{1} \; \kw{or} \; e_{2} : T}
\mylabel{T-OR2}
\]

\[
\frac{\env \vdash e_{1}:T_{1} \cup \Nil \;\;\;
      \env \vdash e_{2}:T_{2}}
     {\env \vdash e_{1} \; \kw{or} \; e_{2} : T_{1} \cup T_{2}}
\mylabel{T-OR3}
\]

\[
\frac{\env \vdash e_{1}:T_{1} \cup \False \;\;\;
      \env \vdash e_{2}:T_{2}}
     {\env \vdash e_{1} \; \kw{or} \; e_{2} : T_{1} \cup T_{2}}
\mylabel{T-OR4}
\]

\[
\frac{\env \vdash e_{1}:T_{1} \;\;\;
      \env \vdash e_{2}:T_{2}}
     {\env \vdash e_{1} \; \kw{or} \; e_{2} : T_{1} \cup T_{2}}
\mylabel{T-OR5}
\]

\[
\frac{\env \vdash e:T}
     {\env \vdash \kw{not} \; e : \Boolean}
\mylabel{T-NOT}
\]

\[
\frac{\env \vdash e:T \;\;\;
      T \subtype \Number}
     {\env \vdash - e : \Number}
\mylabel{T-MINUS1}
\]

\[
\frac{\env \vdash e:\Any}
     {\env \vdash - e : \Any}
\mylabel{T-MINUS2}
\]

\[
\frac{\env \vdash e:T \;\;\;
      T \subtype \String}
     {\env \vdash \# e : \Number}
\mylabel{T-LEN1}
\]

\[
\frac{\env \vdash e:\Any}
     {\env \vdash \# e : \Any}
\mylabel{T-LEN2}
\]

\[
\frac{\env \vdash \vec{e_{2}}:S_{1} \;\;\;
      \env \vdash e_{1}:S_{2} \rightarrow S_{3} \;\;\;
      S_{1} \lesssim S_{2}}
     {\env \vdash e_{1}(\vec{e_{2}}) : S_{3}}
\mylabel{T-EXPCALL1}
\]

\[
\frac{\env \vdash \vec{e_{2}}:S \;\;\;
      \env \vdash e_{1}:\Any}
     {\env \vdash e_{1}(\vec{e_{2}}) : \Any{*}}
\mylabel{T-EXPCALL2}
\]

\end{document}
