\documentclass[12pt]{article}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amssymb}

\newcommand{\mylabel}[1]{\; (\textsc{#1})}
\newcommand{\subtype}{<:}
\newcommand{\pipe}{\;|\;}
\newcommand{\env}{\Gamma}

\title{Typed Lua Type System}

\author{AndrÃ© Murbach Maidl}

\begin{document}

\maketitle

\section{Type Language}

\begin{align*}
T ::= \; & C \pipe B \pipe Object \pipe Any \pipe
T \rightarrow T \pipe T \cup T\\
C ::= \; & \mathbf{nil} \pipe \mathbf{false} \pipe \mathbf{true}
\pipe {<}double{>} \pipe {<}integer{>} \pipe {<}string{>}\\
B ::= \; & Boolean \pipe Number \pipe String\\
V ::= \; & T \pipe {T*} \pipe T \times V\\ 
\end{align*}

\section{Subtyping}

\subsection{Constant types}

\[
C \subtype C
\mylabel{S-CONSTANT}
\]
\[
\mathbf{false} \subtype Boolean
\mylabel{S-FALSE}
\]
\[
\mathbf{true} \subtype Boolean
\mylabel{S-TRUE}
\]
\[
{<}double{>} \subtype Number
\mylabel{S-DOUBLE}
\]
\[
{<}integer{>} \subtype Number
\mylabel{S-INTEGER}
\]
\[
{<}string{>} \subtype Number
\mylabel{S-STRING}
\]

\subsection{Basic types}

\[
B \subtype B
\mylabel{S-BASIC}
\]

\subsection{Object (Top) type}

\[
T \subtype Object
\mylabel{S-OBJECT}
\]

\subsection{Any type}

\[
Any \subtype Any
\mylabel{S-ANY}
\]

\subsection{Function types}

\[
\frac{T_{1} \subtype S_{1} \;\;\; S_{2} \subtype T_{2}}
     {S_{1} \rightarrow S_{2} \subtype T_{1} \rightarrow T_{2}}
\mylabel{S-FUNCTION}
\]

\subsection{Union types}

\[
T_{1} \subtype T_{1} \cup T_{2}
\mylabel{S-UNION1}
\]
\[
T_{2} \subtype T_{1} \cup T_{2}
\mylabel{S-UNION2}
\]
\[
\frac{S_{1} \subtype T \;\;\; S_{2} \subtype T}
     {S_{1} \cup S_{2} \subtype T}
\mylabel{S-UNION3}
\]

\subsection{Product types}

\[
\frac{T_{1} \subtype T_{2} \;\;\; V_{1} \subtype V_{2}}
     {T_{1} \times V_{1} \subtype T_{2} \times V_{2}}
\mylabel{S-PROD}
\]

\subsection{VarArg types}

\[
\frac{T_{1}* \subtype T_{2}*}
     {T_{1} \subtype T_{2}}
\mylabel{VARARG-1}
\]
\[
{T*} \subtype (T \cup Nil) \times {T*}
\mylabel{VARARG-2}
\]

\section{Typing Rules}

\subsection{Abstract Syntax}

\begin{align*}
k ::= \; & \mathbf{nil} \pipe \mathbf{false} \pipe \mathbf{true}
\pipe n \pipe w\\ 
v ::= \; & id \pipe e[e]\\
s ::= \; & \overline{s}
\pipe \mathbf{if} \; e \; \mathbf{then} \; s \; \mathbf{else} \; s
\pipe \mathbf{while} \; e \; \mathbf{do} \; s \; \mathbf{end} \pipe\\
& \mathbf{repeat} \; s \; \mathbf{until} \; e
\pipe \mathbf{for} \; id = e,e,e \; \mathbf{do} \; s \; \mathbf{end} \pipe\\
& \mathbf{for} \; \overline{id} \; \mathbf{in} \; \overline{e} \;
  \mathbf{do} \; s \; \mathbf{end}
\pipe \mathbf{function} \; name \;
  (\overline{id}) \; s \; \mathbf{end} \pipe\\
& \mathbf{local} \; \mathbf{function} \; id \;
  (\overline{id}) \; s \; \mathbf{end}
\pipe \mathbf{::} \; id \; \mathbf{::} \pipe \mathbf{goto} \; id \pipe\\
& \mathbf{break} \pipe \overline{v} = \overline{e}
\pipe \mathbf{local} \; \overline{id} = \overline{e}
\pipe \mathbf{return} \; \overline{e} \pipe e(\overline{e})\\
e ::= \; & k \pipe {...} \pipe v
\pipe \mathbf{function} \; (\overline{id}) \; s \; \mathbf{end}
\pipe \{(\overline{e},\overline{(e,e)})\}
\pipe id(e,\overline{e}) \pipe e(\overline{e}) \pipe\\
& e + e \pipe e \; {..} \; e \pipe e == e \pipe e < e
\pipe e \; \mathbf{and} \; e \pipe e \; \mathbf{or} \; e \pipe\\
& \mathbf{not} \; e \; | - e \pipe \# \; e
\end{align*}

\subsection{Expressions}

\[
\env \vdash k : k
\mylabel{T-CONSTANT}
\]
\[
\frac{\env({...}) = T}
     {\env \vdash {...} : T*}
\mylabel{T-VARARG}
\]
\[
\frac{\env(v) = T}
     {\env \vdash v : T}
\mylabel{T-VAR}
\]
\[
\frac{\env \vdash s:V}
     {\env \vdash \mathbf{function} \; () \; s : {Object*} \rightarrow V}
\mylabel{T-ANONFUNC1}
\]
\[
\frac{\env \vdash \overline{id}:V_{1} \;\;\; \env \vdash s:V_{2}}
     {\env \vdash \mathbf{function} \; (\overline{id}) \; s :
     {V_{1}} \rightarrow V_{2}}
\mylabel{T-ANONFUNC2}
\]
\[
\env \vdash \{(\overline{e},\overline{(e,e)})\} : Any
\mylabel{T-TABLE}
\]
\[
\env \vdash id(e,\overline{e}) : Any
\mylabel{T-METHODCALL}
\]
\[
\frac{\env \vdash e_{1}:V_{1} \rightarrow V_{2} \;\;\;
      \env \vdash \overline{e_{2}}:V_{3} \;\;\; V_{3} \lesssim V_{1}}
     {\env \vdash e_{1}(\overline{e_{2}}) : V_{2}}
\mylabel{T-FUNCCALL1}
\]
\[
\frac{\env \vdash e_{1}:Any \;\;\; \env \vdash \overline{e_{2}}:V}
     {\env \vdash e_{1}(\overline{e_{2}}) : Any}
\mylabel{T-FUNCCALL2}
\]
\[
\frac{\env \vdash e_{1}:T_{1} \;\;\; \env \vdash e_{2}:T_{2} \;\;\;
      T_{1} \subtype Number \;\;\; T_{2} \subtype Number}
     {\env \vdash e_{1} + e_{2} : Number}
\mylabel{T-ARITH1}
\]
\[
\frac{\env \vdash e_{1}:Any \;\;\; \env \vdash e_{2}:T}
     {\env \vdash e_{1} + e_{2} : Any}
\mylabel{T-ARITH2}
\]
\[
\frac{\env \vdash e_{1}:T \;\;\; \env \vdash e_{2}:Any}
     {\env \vdash e_{1} + e_{2} : Any}
\mylabel{T-ARITH3}
\]
\[
\frac{\env \vdash e_{1}:T_{1} \;\;\; \env \vdash e_{2}:T_{2} \;\;\;
      T_{1} \subtype String \;\;\; T_{2} \subtype String}
     {\env \vdash e_{1} \; {..} \;  e_{2} : String}
\mylabel{T-CONCAT1}
\]
\[
\frac{\env \vdash e_{1}:Any \;\;\; \env \vdash e_{2}:T}
     {\env \vdash e_{1} \; {..} \; e_{2} : Any}
\mylabel{T-CONCAT2}
\]
\[
\frac{\env \vdash e_{1}:T \;\;\; \env \vdash e_{2}:Any}
     {\env \vdash e_{1} \; {..} \; e_{2} : Any}
\mylabel{T-CONCAT3}
\]
\[
\frac{\env \vdash e_{1}:T_{1} \;\;\; \env \vdash e_{2}:T_{2}}
     {\env \vdash e_{1} == e_{2} : Boolean}
\mylabel{T-EQUAL}
\]
\[
\frac{\env \vdash e_{1}:T_{1} \;\;\; \env \vdash e_{2}:T_{2} \;\;\;
      T_{1} \subtype Number \;\;\; T_{2} \subtype Number}
     {\env \vdash e_{1} < e_{2} : Boolean}
\mylabel{T-ORDER1}
\]
\[
\frac{\env \vdash e_{1}:T_{1} \;\;\; \env \vdash e_{2}:T_{2} \;\;\;
      T_{1} \subtype String \;\;\; T_{2} \subtype String}
     {\env \vdash e_{1} < e_{2} : Boolean}
\mylabel{T-ORDER2}
\]
\[
\frac{\env \vdash e_{1}:Any \;\;\; \env \vdash e_{2}:T}
     {\env \vdash e_{1} < e_{2} : Any}
\mylabel{T-ORDER3}
\]
\[
\frac{\env \vdash e_{1}:T \;\;\; \env \vdash e_{2}:Any}
     {\env \vdash e_{1} < e_{2} : Any}
\mylabel{T-ORDER4}
\]
\[
\frac{\env \vdash e_{1}:T_{1} \;\;\; \env \vdash e_{2}:T_{2}}
     {\env \vdash e_{1} \; \mathbf{and} \; e_{2} : T_{1} \cup T_{2}}
\mylabel{T-AND}
\]
\[
\frac{\env \vdash e_{1}:T_{1} \;\;\; \env \vdash e_{2}:T_{2}}
     {\env \vdash e_{1} \; \mathbf{or} \; e_{2} : T_{1} \cup T_{2}}
\mylabel{T-OR}
\]
\[
\frac{\env \vdash e:T}
     {\env \vdash \mathbf{not} \; e : Boolean}
\mylabel{T-NOT}
\]
\[
\frac{\env \vdash e:T \;\;\; T \subtype Number}
     {\env \vdash - \; e : Number}
\mylabel{T-MINUS1}
\]
\[
\frac{\env \vdash e:Any}
     {\env \vdash - \; e : Any}
\mylabel{T-MINUS2}
\]
\[
\frac{\env \vdash e:T \;\;\; T \subtype String}
     {\env \vdash \# \; e : Number}
\mylabel{T-LEN1}
\]
\[
\frac{\env \vdash e:Any}
     {\env \vdash \# \; e : Any}
\mylabel{T-LEN2}
\]

\subsection{Variables}

\[
\frac{\env(id) = T}
     {\env \vdash id : T}
\mylabel{T-ID}
\]
\[
\frac{\env \vdash e_{1}:T_{1} \;\;\; \env \vdash e_{2}:T_{2}}
     {\env \vdash e_{1}[e_{2}] : Any}
\mylabel{T-INDEX}
\]

\subsection{Statements}

\[
\env \vdash \overline{s} : V
\mylabel{T-BLOCK}
\]
\[
\frac{\env \vdash e:T \;\;\; \env \vdash s_{1}:V \;\;\; \env \vdash s_{2}:V}
     {\env \vdash \mathbf{if} \; e \; \mathbf{then} \; s_{1} \;
      \mathbf{else} \; s_{2} \; \mathbf{end} : V}
\mylabel{T-IF-ELSE1}
\]
\[
\frac{\env \vdash e:T \;\;\;
      \env \vdash s_{1}:V_{1} \;\;\; \env \vdash s_{2}:V_{2}}
     {\env \vdash \mathbf{if} \; e \; \mathbf{then} \; s_{1} \;
      \mathbf{else} \; s_{2} \; \mathbf{end} : V_{1} \cup V_{2}}
\mylabel{T-IF-ELSE2}
\]
\[
\frac{\env \vdash e:T \;\;\; \env \vdash s:V}
     {\env \vdash \mathbf{while} \; e \; \mathbf{do} \; s \; \mathbf{end}: V}
\mylabel{T-WHILE}
\]
\[
\frac{\env \vdash s:V \;\;\; \env \vdash e:T}
     {\env \vdash \mathbf{repeat} \; s \; \mathbf{unil} \; e : V}
\mylabel{T-REPEAT}
\]
\[
\frac{\begin{aligned}
      & \env \vdash e_{1}:T_{1} \;\;\; \env \vdash e_{2}:T_{2} \;\;\;
      \env \vdash e_{3}:T_{3} \;\;\; \env \vdash s:V\\
      & T_{1} \lesssim Number \;\;\;
      T_{2} \lesssim Number \;\;\;
      T_{3} \lesssim Number
      \end{aligned}}
     {\env \vdash \mathbf{for} \; id = e_{1},e_{2},e_{3} \;
      \mathbf{do} \; s \; \mathbf{end} : V}
\mylabel{T-FORNUM}
\]
\[
\frac{\env \vdash \overline{id}:V_{1} \;\;\; \env \vdash \overline{e}:V_{1}
      \;\;\; \env \vdash s:V}
     {\env \vdash \textbf{for} \; \overline{id} \; \mathbf{in} \; \overline{e}
      \; \mathbf{do} \; s \; \mathbf{end} : V}
\mylabel{T-FORGEN}
\]
\[
\frac{\env \vdash s:V}
     {\env \vdash \mathbf{function} \; name \; ()
      \; s \; \mathbf{end} : {Object*} \rightarrow V}
\mylabel{T-GLOBALFUNC1}
\]
\[
\frac{\env \vdash \overline{id}:V_{1} \;\;\; \env \vdash s:V_{2}}
     {\env \vdash \mathbf{function} \; fname \; (\overline{id})
      \; s \; \mathbf{end} : V_{1} \rightarrow V_{2}}
\mylabel{T-GLOBALFUNC2}
\]
\[
\frac{\env \vdash s:V}
     {\env \vdash \mathbf{local} \; \mathbf{function} \; id \; ()
      \; s \; \mathbf{end} : {Object*} \rightarrow V}
\mylabel{T-LOCALFUNC1}
\]
\[
\frac{\env \vdash \overline{id}:V_{1} \;\;\; \env \vdash s:V_{2}}
     {\env \vdash \mathbf{local} \; \mathbf{func} \; id \; (\overline{id})
      \; s \; \mathbf{end} : V_{1} \rightarrow V_{2}}
\mylabel{T-LOCALFUNC2}
\]
\[
\frac{\env \vdash \overline{id}:V_{1} \;\;\; \env \vdash \overline{e}:V_2
      \;\;\; V_{1} \lesssim V_{2}}
     {\env \vdash \mathbf{local} \; \overline{id} = \overline{e} : Nil}
\mylabel{T-LOCALVAR}
\]
\[
\env \vdash \mathbf{::} \; id \; \mathbf{::} : Nil
\mylabel{T-LABEL}
\]
\[
\env \vdash \mathbf{goto} \; id : Nil
\mylabel{T-GOTO}
\]
\[
\env \vdash \mathbf{break} : Nil
\mylabel{T-BREAK}
\]
\[
\frac{\env \vdash \overline{v}:V_{1} \;\;\; \env \vdash \overline{e}:V_2
      \;\;\; V_{1} \lesssim V_{2}}
     {\env \vdash \overline{v} = \overline{e} : Nil}
\mylabel{T-ASSIGNMENT}
\]
\[
\frac{\env \vdash \overline{e}:V}
     {\env \vdash \mathbf{return} \; \overline{e} : V}
\mylabel{T-RETURN}
\]

\end{document}
